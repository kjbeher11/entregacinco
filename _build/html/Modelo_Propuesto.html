
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Librerías y paquetes necesarios &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Modelo_Propuesto';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Proyecto Superintendencia" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Proyecto Superintendencia
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Librerías y paquetes necesarios</a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FModelo_Propuesto.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Modelo_Propuesto.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Librerías y paquetes necesarios</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Librerías y paquetes necesarios</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-propuesto-mejorado">Modelo propuesto mejorado</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variables-a-utilizar"><em>Variables a utilizar</em></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-base-xgboost">Modelo de base XGBoost</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lanzamiento-del-modelo-de-clasificacion-de-base-xgboost"><strong>Lanzamiento del modelo de clasificación de base XGBoost</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#importancia-de-las-variables">Importancia de las variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seleccion-de-empresas-por-categoria">Selección de empresas por categoría</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#supuestos-del-modelo">Supuestos del modelo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#independencia-de-las-observaciones">Independencia de las observaciones</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estacionariedad-de-las-series-temporales"><strong>Estacionariedad de las series temporales</strong></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#verificar-poca-o-nula-multicolinealidad">Verificar poca o nula multicolinealidad</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#homocedasticidad-de-las-probabilidades-extraidas-de-los-residuos">Homocedasticidad de las probabilidades extraídas de los residuos</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#verificacion-de-la-no-colinealidad-temporal">Verificación de la no colinealidad temporal</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conslusion-del-modelo-base-xgboost">Conslusión del modelo base XGBoost</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-stacking-con-ligthgbm">Modelo de stacking con LIgthGBM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gridsearch-de-mejores-hiperparametros">Gridsearch de mejores hiperparámetros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#entrenmiento-del-modelo-matriz-de-confusion-y-metricas-del-modelo">Entrenmiento del modelo, matriz de confusión y métricas del modelo.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#meta-modelaje-xgboost-ligthgbm">Meta Modelaje - XGBoost + LigthGBM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metricas-reelevantes-del-modelo">Metricas reelevantes del modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resumen-de-metricas-por-ano">Resumen de Métricas por Año</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2018">Año 2018:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2019">Año 2019:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2020">Año 2020:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2021">Año 2021:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2022">Año 2022:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2023">Año 2023:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2018">Matriz de Confusión - Año 2018</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2019">Matriz de Confusión - Año 2019</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2020">Matriz de Confusión - Año 2020</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2021">Matriz de Confusión - Año 2021</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2022">Matriz de Confusión - Año 2022</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2023">Matriz de Confusión - Año 2023</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-general">Conclusión General</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#variables-de-interes">Variables de interés</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#importancia-de-variables-a-lo-largo-de-lso-anos">Importancia de variables a lo largo de lso años</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Supuestos del modelo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculo-de-probabilidades-de-clasificacion-en-clases">Calculo de probabilidades de clasificacion en clases</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multicolinealidad">Multicolinealidad</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#normalidad-de-los-residuos">Normalidad de los residuos</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resultados">Resultados:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decisiones-en-funcion-del-nivel-de-significancia">Decisiones en función del Nivel de Significancia:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusión:</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#autocorrelacion-de-los-residuos">Autocorrelacion de los residuos</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-del-meta-modelo-xgboost-lightgbm">Conclusion del meta modelo XGBoost / LightGBM</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="librerias-y-paquetes-necesarios">
<h1>Librerías y paquetes necesarios<a class="headerlink" href="#librerias-y-paquetes-necesarios" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s1">&#39;/content/drive&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>
<span class="kn">import</span> <span class="nn">graphviz</span>
<span class="kn">import</span> <span class="nn">optuna</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.outliers_influence</span> <span class="kn">import</span> <span class="n">variance_inflation_factor</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">class_weight</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">SMOTE</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">GroupKFold</span><span class="p">,</span> <span class="n">PredefinedSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">class_weight</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelBinarizer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">label_binarize</span>
<span class="kn">from</span> <span class="nn">statsmodels.genmod.generalized_estimating_equations</span> <span class="kn">import</span> <span class="n">GEE</span>
<span class="c1"># Instead of importing Multinomial from discrete_model, use MNLogit</span>
<span class="kn">from</span> <span class="nn">statsmodels.discrete.discrete_model</span> <span class="kn">import</span> <span class="n">MNLogit</span> <span class="c1"># Changed import statement</span>
<span class="kn">from</span> <span class="nn">statsmodels.genmod.cov_struct</span> <span class="kn">import</span> <span class="n">Independence</span>
<span class="kn">from</span> <span class="nn">statsmodels.genmod.generalized_estimating_equations</span> <span class="kn">import</span> <span class="n">NominalGEE</span>
<span class="kn">from</span> <span class="nn">statsmodels.genmod.cov_struct</span> <span class="kn">import</span> <span class="n">Independence</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">RFE</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">label_binarize</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span> <span class="nn">sklearn.multiclass</span> <span class="kn">import</span> <span class="n">OneVsRestClassifier</span>
<span class="kn">from</span> <span class="nn">patsy</span> <span class="kn">import</span> <span class="n">dmatrices</span>
<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools</span> <span class="kn">import</span> <span class="n">add_constant</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.stattools</span> <span class="kn">import</span> <span class="n">durbin_watson</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics.tsaplots</span> <span class="kn">import</span> <span class="n">plot_acf</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">adfuller</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.diagnostic</span> <span class="kn">import</span> <span class="n">het_breuschpagan</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mounted at /content/drive
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.10/dist-packages/dask/dataframe/__init__.py:42: FutureWarning: 
Dask dataframe query planning is disabled because dask-expr is not installed.

You can install it with `pip install dask[dataframe]` or `conda install dask`.
This will raise in a future version.

  warnings.warn(msg, FutureWarning)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">filepath</span> <span class="o">=</span> <span class="s1">&#39;/content/drive/My Drive/PYMES/finalpymes.xlsx&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">headers</span> <span class="o">=</span> <span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;pretty&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+---+---------------------------+-----------+----------------------------------------+---------------------------------------------------+--------------------------------------------+--------------------------------+--------------------------------------------+----------------+-------------------------------------------------------------------------------------------+---------------------------+-----------------------------+--------------------+----------------------------------------+-------------------+----------------------+----------------------+-----------------------+----------------------+------------------------+----------------------+-------------+-------------------+-------------------+--------------------+---------------------+-------------------+-------------------+-------------------+-------------------+
|   |       Estado actual       |    NIT    | Concepto del Revisor fiscal en su orme | La compañía está obligada a tener Revisor fiscal? |              Tipo societario               | Cantidad de años de la empresa | Departamento de la dirección del domicilio | Fecha de Corte |           Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)            | Total de activos (Assets) | Total pasivos (Liabilities) |  Razón corriente   | Rotación inventario producto terminado | Rotación cartera  | Rotación proveedores |  Productividad KTNO  |          ROA          |         ROE          | Nivel de endeudamiento | Generación Efectivo  |     FLC     |      FDC/FLC      |        SD         |        FDC         |   Generación FLC    | Tasa de Desempleo | Tasa de Ocupación |        PIB        |      PIB DEP      |
+---+---------------------------+-----------+----------------------------------------+---------------------------------------------------+--------------------------------------------+--------------------------------+--------------------------------------------+----------------+-------------------------------------------------------------------------------------------+---------------------------+-----------------------------+--------------------+----------------------------------------+-------------------+----------------------+----------------------+-----------------------+----------------------+------------------------+----------------------+-------------+-------------------+-------------------+--------------------+---------------------+-------------------+-------------------+-------------------+-------------------+
| 0 |          ACTIVA           | 800000268 |               03. LIMPIO               |                        SI                         | 08. SOCIEDAD POR ACCIONES SIMPLIFICADA SAS |              30.0              |                 ATLANTICO                  |      2017      |                                Actividades inmobiliarias.                                 |         3766237.0         |          2810145.0          | 0.2770673194815656 |                  nan                   |        0.0        |         nan          |  -1.759056666666667  |  0.00956764006088836  | 0.03768884165958925  |   0.746141307623498    |  -1.131486929011489  |  -40772.0   |        1.0        |        0.0        |      -40772.0      | -1.131486929011489  |    7.557648041    |     11.548318     | 8535.557382835923 | 36782.62700791498 |
| 1 |          ACTIVA           | 800000276 |               03. LIMPIO               |                        SI                         |            01. SOCIEDAD ANÓNIMA            |              30.0              |                 SANTANDER                  |      2017      |                    Agricultura, ganadería, caza, silvicultura y pesca.                    |        158570380.0        |         107975408.0         | 1.012116577964098  |           22.26238120232659            | 23.42703814767868 |  37.68944667923766   | 0.002229827779511632 | -0.009780243952243792 | -0.03065239368054201 |   0.6809304991260032   | 0.004369197160021846 | -14525925.0 |        1.0        |        0.0        |    -14525925.0     |  9.366385811199873  |    7.630039801    |    211.472511     | 5140.802274862169 | 49333.91088687588 |
| 2 |          ACTIVA           | 800000313 |               03. LIMPIO               |                        SI                         | 08. SOCIEDAD POR ACCIONES SIMPLIFICADA SAS |              30.0              |                BOGOTA D.C.                 |      2017      |                                Industrias manufactureras.                                 |         4973845.0         |          1885365.0          | 2.156701857521809  |           126.2668797308069            | 56.29611837647643 |  40.09990848866598   |  0.2251621814081026  | 0.002475348548255927  | 0.003986426980262136 |   0.3790558411048193   |  -18.71393762183236  |  -134970.0  | 1.852263465955398 | 115030.0000000001 | -250000.0000000001 | -10.96247563352827  |    8.729730232    |     173.33773     | 19523.99852216619 | 212289.1419694344 |
| 3 |          ACTIVA           | 800000439 |               03. LIMPIO               |                        SI                         |           03. SOCIEDAD LIMITADA            |              30.0              |                CUNDINAMARCA                |      2017      | Comercio al por mayor y al por menor; reparación de vehículos automotores y motocicletas. |         2969939.0         |          1429029.0          |  2.61471657534948  |           137.5492090925299            | 65.4890345987105  |  61.94919698251261   |  0.2875934303809994  |  0.06271980670310064  |  0.1208857103919113  |   0.4811644279562644   |  -1.449246808464949  |  -81721.0   | 5.966667074558559 | 405880.9999999999 | -487601.9999999999 | -0.4387139375328817 |    8.729730232    |    227.644906     | 8523.01007833835  | 49985.62183771345 |
| 4 |          ACTIVA           | 800000457 |               03. LIMPIO               |                        SI                         |           03. SOCIEDAD LIMITADA            |              30.0              |                BOGOTA D.C.                 |      2017      |                    Actividades profesionales, científicas y técnicas.                     |         5687179.0         |          3098735.0          | 1.330053213776243  |                  0.0                   | 158.8989930876437 |  204.4392197221931   |  0.1536377224044927  |  0.0755460659845593   |  0.1659854337200264  |   0.5448632793165118   |  1.461835845490685   |  628069.0   |        1.0        |        0.0        |      628069.0      |  1.461835845490685  |    8.729730232    |     78.165053     | 83519.07672308842 | 212289.1419694344 |
| 5 |          ACTIVA           | 800000750 |               03. LIMPIO               |                        SI                         |          02. SUCURSAL EXTRANJERA           |              30.0              |                BOGOTA D.C.                 |      2017      |                             Explotación de minas y canteras.                              |        333195657.0        |         130526706.0         | 0.887749815897006  |           2.493111301553211            | 87.24733293869737 |  171.0316578989982   | -0.03816762871691842 | 0.005689470916483164  | 0.009353712004953338 |   0.3917419187729689   |  2.062463766816285   | 17443156.0  |        1.0        |        0.0        |     17443156.0     |  9.201398739362148  |    8.729730232    |     5.876447      | 369.9643265204268 | 212289.1419694344 |
| 6 |          ACTIVA           | 800001020 |               03. LIMPIO               |                        SI                         |            01. SOCIEDAD ANÓNIMA            |              30.0              |                   VALLE                    |      2017      |                   Actividades de servicios administrativos y de apoyo.                    |        29006566.0         |          6050575.0          | 4.789251930601637  |                  0.0                   | 404.2584443266219 |  653.5270796451218   |  3.954458744509553   |  0.09524843444067112  |  0.1203533317293947  |   0.2085932888436363   | -0.6037714951698078  | -1675545.0  |        1.0        |        0.0        |     -1675545.0     | -0.6064596808345066 |    12.47002538    |        nan        |      62898.0      | 80979.08853948898 |
| 7 |          ACTIVA           | 800001047 |               03. LIMPIO               |                        SI                         |           03. SOCIEDAD LIMITADA            |              30.0              |                   VALLE                    |      2017      | Comercio al por mayor y al por menor; reparación de vehículos automotores y motocicletas. |         3806134.0         |          1189678.0          | 3.072351510240586  |           82.80798621152292            | 32.3457489359679  |  47.63873165280584   |  0.2426788518385197  |  0.09886751228411822  |  0.1438216427105979  |   0.3125686063601544   | -0.8150772117150276  |   62170.0   |        1.0        |        0.0        |      62170.0       | 0.1652126079249966  |    12.47002538    |    380.550857     | 16087.79789959558 | 80979.08853948898 |
| 8 |          ACTIVA           | 800001075 |               03. LIMPIO               |                        SI                         |   05. SOCIEDAD EN COMANDITA POR ACCIONES   |              20.0              |                BOGOTA D.C.                 |      2017      |                    Agricultura, ganadería, caza, silvicultura y pesca.                    |        57723657.0         |         20259516.0          | 1.400387248183013  |            43.5193362577913            | 210.6976169396886 |  208.0329760983316   |  0.1930637944997342  | 0.004913548703263898  | 0.007570652694265698 |   0.3509742288157522   | -0.0377360486270749  |  283628.0   |        1.0        |        0.0        |      283628.0      |         1.0         |    8.729730232    |    270.790935     | 13.45199351238249 | 212289.1419694344 |
| 9 | ACUERDO DE REORGANIZACION | 800001161 |               03. LIMPIO               |                        SI                         | 08. SOCIEDAD POR ACCIONES SIMPLIFICADA SAS |              30.0              |                 ANTIOQUIA                  |      2017      |                                Industrias manufactureras.                                 |         5790019.0         |          4005805.0          | 1.008441249636465  |           6502.498055147376            | 8656.569699127649 |   8746.41196300458   |  0.4013292979645125  |  -0.0082355515586391  | -0.02672549369077925 |   0.6918466070664017   |  -0.036385370354836  |   1735.0    |        1.0        |        0.0        |       1735.0       | -0.036385370354836  |    8.274572445    |    395.010978     | 20388.20480577755 | 120465.3882884336 |
+---+---------------------------+-----------+----------------------------------------+---------------------------------------------------+--------------------------------------------+--------------------------------+--------------------------------------------+----------------+-------------------------------------------------------------------------------------------+---------------------------+-----------------------------+--------------------+----------------------------------------+-------------------+----------------------+----------------------+-----------------------+----------------------+------------------------+----------------------+-------------+-------------------+-------------------+--------------------+---------------------+-------------------+-------------------+-------------------+-------------------+
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Número de filas: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Número de columnas: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Número de filas: 141621
Número de columnas: 29
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="modelo-propuesto-mejorado">
<h1>Modelo propuesto mejorado<a class="headerlink" href="#modelo-propuesto-mejorado" title="Link to this heading">#</a></h1>
<p>Se realizó una inspección de diferentes modelos de machine learning para el modelamiento de los datos de tipo panel y la extracción de variables significativas para cada año respetando la dependencia temporal y por grupo o ‘NIT’ de cada observación. Inicalmente se consideró realizar un pliegue de validación temporal secuencial teniendo en cuenta la dependencia en tiempo de las observaciones. Se realizó una comparación con otros modelos como regresión logística multinomial con variables de lagg para cada año, modelo de clasificación KNN implementando validación secuencial, modelo clasificatorio de maquinas de soporte vectorial con validación secuencial, modelo de xtreme gradient boosting (XGBoost) con validación secuencial, modelo de penalización clasificatoria L2, L1 con validación secuencial.</p>
<p>Se propone el uso del modelo de clasificación de <code class="docutils literal notranslate"><span class="pre">Extreme</span> <span class="pre">Gradient</span> <span class="pre">Boosting</span> <span class="pre">(XGBoost)</span></code> como base para la predicción de etiquetas de clasificación teneindo en cuenta sus relevantes resultados en la comparación con los demás modelos. Se propone la siguiente metodología de clasificación:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Stacking</span></code>: Prueba independiente del modelo XGBoost + Predicción de etiquetas de clasificación sobre los resisudos de clasificación con LigthGBM
2.<code class="docutils literal notranslate"> <span class="pre">Meta-modelo:</span></code> Clasificación de las etiquetas de las categorías con XGBoost y refuerzo de las predicciones con el cálculo de las probabilidades de las clases como enrada para LigthGBM.</p></li>
</ol>
<p>Se evalúan las dos opciones de clasificación y se presenta un resultado final con la que presente mejor rendimiento de clasificación.</p>
<p>Para el entrenamiento del modelo y la búsqueda de hiperparámetros se consideró el uso de variables microeconómicas o indicadores financieros no reduntantes y con baja multicolinealidad. Del mismo modo, la división en categorías de la variable objetivo <code class="docutils literal notranslate"><span class="pre">ratio</span> <span class="pre">entre</span> <span class="pre">flujo</span> <span class="pre">disponible</span> <span class="pre">y</span> <span class="pre">flujo</span> <span class="pre">libre</span> <span class="pre">de</span> <span class="pre">caja</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># 1. Definir las columnas que NO necesitas eliminar</span>
<span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;NIT&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;Cantidad de años de la empresa&#39;</span><span class="p">,</span> <span class="s1">&#39;Razón corriente&#39;</span><span class="p">,</span> <span class="s1">&#39;Rotación cartera&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ROA&#39;</span><span class="p">,</span> <span class="s1">&#39;ROE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Generación Efectivo&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Estado actual&#39;</span><span class="p">,</span> <span class="s1">&#39;Concepto del Revisor fiscal en su orme&#39;</span><span class="p">,</span>
    <span class="s1">&#39;La compañía está obligada a tener Revisor fiscal?&#39;</span><span class="p">,</span> <span class="s1">&#39;Tipo societario&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Departamento de la dirección del domicilio&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)&#39;</span>
<span class="p">]</span>

<span class="c1"># 2. Filtrar las columnas que deseas mantener (las que están en &#39;columns_to_keep&#39;)</span>
<span class="n">data_filter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;0&#39;</span><span class="p">,</span> <span class="s1">&#39;[0, 0.67)&#39;</span><span class="p">,</span> <span class="s1">&#39;[0.67, 0.80)&#39;</span><span class="p">,</span> <span class="s1">&#39;[0.80, 1)&#39;</span><span class="p">,</span> <span class="s1">&#39;[1, ∞)&#39;</span><span class="p">]</span>
<span class="n">data_filter</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;FDC/FLC&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="variables-a-utilizar">
<h2><em>Variables a utilizar</em><a class="headerlink" href="#variables-a-utilizar" title="Link to this heading">#</a></h2>
<p>Se destaca la selección y transformación a su respectivo tipo de las variables involucradas en el análisis para un posterior tratamiento y modelamiento óptimo.</p>
<p>Posterior a la prueba de multicolinealidad y de selección manual por parte de los expertos investigadores de las variables a implementar en el modelo dado que responden a la pregunta de investigación, ¿Qué variables influyen en la clasificación en las escalas de las empresas? Se listan a continuación:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Cantidad</span> <span class="pre">de</span> <span class="pre">años</span> <span class="pre">de</span> <span class="pre">la</span> <span class="pre">empresa:</span></code> Numéro de años en existencia de la empresa</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Razón</span> <span class="pre">corriente:</span></code> Ratio entre Total activos y Total pasivos</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Rotación</span> <span class="pre">de</span> <span class="pre">cartera:</span></code> Ratio entre tital de ventas o ingresos y cuentas por cobrar del periodo anual.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROA</span></code>: Ratio entre beneficio neto de le empresa y promedio de activos de la empresa.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROE</span></code>: Ratio entre beneficio neto y patrimonio de la empresa.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Generación</span> <span class="pre">de</span> <span class="pre">efectivo:</span></code> Cálculo mediante el flujo de caja operativo</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Estado</span> <span class="pre">actual:</span></code> Estado en el que se encontraba una empresa determinada en un periódo de tiempo dado.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Concepto</span> <span class="pre">de</span> <span class="pre">revisro</span> <span class="pre">fiscal</span> <span class="pre">en</span> <span class="pre">su</span> <span class="pre">orme:</span></code> En qué condicionameinto se debía tener el revisor fiscal para la empresa.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Tipo</span> <span class="pre">socieetario</span></code>: El tipo de sociedad de una empresa en particular</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Departamento</span> <span class="pre">de</span> <span class="pre">domicilio:</span></code> La ubicación particular en terminos de departamento en colombia de la empresa.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CIUU</span></code>: Categoría de la empresa.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_vars</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Cantidad de años de la empresa&#39;</span><span class="p">,</span> <span class="s1">&#39;Razón corriente&#39;</span><span class="p">,</span> <span class="s1">&#39;Rotación cartera&#39;</span><span class="p">,</span> <span class="s1">&#39;ROA&#39;</span><span class="p">,</span> <span class="s1">&#39;ROE&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Generación Efectivo&#39;</span>
<span class="p">]</span>

<span class="n">categorical_vars</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Estado actual&#39;</span><span class="p">,</span> <span class="s1">&#39;Concepto del Revisor fiscal en su orme&#39;</span><span class="p">,</span>
    <span class="s1">&#39;La compañía está obligada a tener Revisor fiscal?&#39;</span><span class="p">,</span> <span class="s1">&#39;Tipo societario&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Departamento de la dirección del domicilio&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FDC_FLC_categoria&#39;</span>
<span class="p">]</span>

<span class="c1"># Convertir las columnas numéricas a tipo &#39;float&#39;</span>
<span class="n">data_filter</span><span class="p">[</span><span class="n">numeric_vars</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_filter</span><span class="p">[</span><span class="n">numeric_vars</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1"># Convertir las columnas categóricas a tipo &#39;category&#39;</span>
<span class="n">data_filter</span><span class="p">[</span><span class="n">categorical_vars</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_filter</span><span class="p">[</span><span class="n">categorical_vars</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Verificar los tipos de datos después de la conversión</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tipos de datos después de la conversión:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_filter</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tipos de datos después de la conversión:
NIT                                                                        int64
Fecha de Corte                                                             int64
Cantidad de años de la empresa                                           float64
Razón corriente                                                          float64
Rotación cartera                                                         float64
ROA                                                                      float64
ROE                                                                      float64
Nivel de endeudamiento                                                   float64
Generación Efectivo                                                      float64
Estado actual                                                           category
Concepto del Revisor fiscal en su orme                                  category
La compañía está obligada a tener Revisor fiscal?                       category
Tipo societario                                                         category
Departamento de la dirección del domicilio                              category
Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)    category
FDC_FLC_categoria                                                       category
dtype: object
</pre></div>
</div>
</div>
</div>
<p>El modelamiemto de los datos se realizó con cerca de 37 mil observaciones a lo largo de los años 2017 hasta 2023 y se contempla el siguiente número de registros por año:</p>
<ul class="simple">
<li><p>Hay <code class="docutils literal notranslate"><span class="pre">4357</span></code> observaciones en el año <code class="docutils literal notranslate"><span class="pre">2017</span></code></p></li>
<li><p>Hay <code class="docutils literal notranslate"><span class="pre">4078</span></code> observaciones en el año <code class="docutils literal notranslate"><span class="pre">2018</span></code></p></li>
<li><p>Hay <code class="docutils literal notranslate"><span class="pre">5278</span></code> observaciones en el año <code class="docutils literal notranslate"><span class="pre">2019</span></code></p></li>
<li><p>Hay <code class="docutils literal notranslate"><span class="pre">5832</span></code> observaciones en el año <code class="docutils literal notranslate"><span class="pre">2020</span></code></p></li>
<li><p>Hay <code class="docutils literal notranslate"><span class="pre">5895</span></code> observaciones en el año <code class="docutils literal notranslate"><span class="pre">2021</span></code></p></li>
<li><p>Hay <code class="docutils literal notranslate"><span class="pre">5910</span></code> observaciones en el año <code class="docutils literal notranslate"><span class="pre">2022</span></code></p></li>
<li><p>Hay <code class="docutils literal notranslate"><span class="pre">5818</span></code> observaciones en el año <code class="docutils literal notranslate"><span class="pre">2023</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Hay </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_filter</span><span class="p">)</span><span class="si">}</span><span class="s1"> observaciones en total en el conjunto de datos&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Hay </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data_filter</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s1"> columnas en total en el conjunto de datos&#39;</span><span class="p">)</span>

<span class="c1"># Contar las observaciones por cada año</span>
<span class="n">conteo_por_ano</span> <span class="o">=</span> <span class="n">data_filter</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="k">for</span> <span class="n">año</span><span class="p">,</span> <span class="n">conteo</span> <span class="ow">in</span> <span class="n">conteo_por_ano</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Hay </span><span class="si">{</span><span class="n">conteo</span><span class="si">}</span><span class="s1"> observaciones en el año </span><span class="si">{</span><span class="n">año</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hay 37168 observaciones en total en el conjunto de datos
Hay 17 columnas en total en el conjunto de datos
Hay 4357 observaciones en el año 2017
Hay 4078 observaciones en el año 2018
Hay 5278 observaciones en el año 2019
Hay 5832 observaciones en el año 2020
Hay 5895 observaciones en el año 2021
Hay 5910 observaciones en el año 2022
Hay 5818 observaciones en el año 2023
</pre></div>
</div>
</div>
</div>
<p>De los datos a modelar que cumplen con el criterio de tener información u haber reportado servicio de deuda en sus resgistros o datos financieros, se puede contemplar a continuación parte de su información.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data_filter</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-9606442f-77ab-4403-a359-4df4b00812a7" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NIT</th>
      <th>Fecha de Corte</th>
      <th>Cantidad de años de la empresa</th>
      <th>Razón corriente</th>
      <th>Rotación cartera</th>
      <th>ROA</th>
      <th>ROE</th>
      <th>Generación Efectivo</th>
      <th>Estado actual</th>
      <th>Concepto del Revisor fiscal en su orme</th>
      <th>La compañía está obligada a tener Revisor fiscal?</th>
      <th>Tipo societario</th>
      <th>Departamento de la dirección del domicilio</th>
      <th>Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)</th>
      <th>FDC_FLC_categoria</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>800000313</td>
      <td>2017</td>
      <td>30.0</td>
      <td>2.156702</td>
      <td>56.296118</td>
      <td>0.002475</td>
      <td>0.003986</td>
      <td>-18.713938</td>
      <td>ACTIVA</td>
      <td>03. LIMPIO</td>
      <td>SI</td>
      <td>08. SOCIEDAD POR ACCIONES SIMPLIFICADA SAS</td>
      <td>BOGOTA D.C.</td>
      <td>Industrias manufactureras.</td>
      <td>[1, ∞)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>800000439</td>
      <td>2017</td>
      <td>30.0</td>
      <td>2.614717</td>
      <td>65.489035</td>
      <td>0.062720</td>
      <td>0.120886</td>
      <td>-1.449247</td>
      <td>ACTIVA</td>
      <td>03. LIMPIO</td>
      <td>SI</td>
      <td>03. SOCIEDAD LIMITADA</td>
      <td>CUNDINAMARCA</td>
      <td>Comercio al por mayor y al por menor; reparaci...</td>
      <td>[1, ∞)</td>
    </tr>
    <tr>
      <th>12</th>
      <td>800001354</td>
      <td>2017</td>
      <td>30.0</td>
      <td>3.387169</td>
      <td>31.099677</td>
      <td>0.077652</td>
      <td>0.123869</td>
      <td>-0.277214</td>
      <td>ACTIVA</td>
      <td>03. LIMPIO</td>
      <td>SI</td>
      <td>03. SOCIEDAD LIMITADA</td>
      <td>VALLE</td>
      <td>Agricultura, ganadería, caza, silvicultura y p...</td>
      <td>[1, ∞)</td>
    </tr>
    <tr>
      <th>13</th>
      <td>800001650</td>
      <td>2017</td>
      <td>30.0</td>
      <td>2.196981</td>
      <td>105.182158</td>
      <td>-0.126416</td>
      <td>-0.333004</td>
      <td>0.003630</td>
      <td>ACTIVA</td>
      <td>03. LIMPIO</td>
      <td>SI</td>
      <td>01. SOCIEDAD ANÓNIMA</td>
      <td>BOGOTA D.C.</td>
      <td>Industrias manufactureras.</td>
      <td>[1, ∞)</td>
    </tr>
    <tr>
      <th>16</th>
      <td>800002143</td>
      <td>2017</td>
      <td>30.0</td>
      <td>0.668726</td>
      <td>11.377192</td>
      <td>0.046760</td>
      <td>0.073899</td>
      <td>-1.020946</td>
      <td>ACTIVA</td>
      <td>03. LIMPIO</td>
      <td>SI</td>
      <td>01. SOCIEDAD ANÓNIMA</td>
      <td>BOGOTA D.C.</td>
      <td>Educación.</td>
      <td>[0, 0.67)</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-9606442f-77ab-4403-a359-4df4b00812a7')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-9606442f-77ab-4403-a359-4df4b00812a7 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-9606442f-77ab-4403-a359-4df4b00812a7');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-2c05c357-0c74-4345-8468-593fbc43e29c">
  <button class="colab-df-quickchart" onclick="quickchart('df-2c05c357-0c74-4345-8468-593fbc43e29c')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-2c05c357-0c74-4345-8468-593fbc43e29c button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div></div>
</div>
<p>Para el conjunto de datos con el que se stá trabajando, se debe inspeccionnar la presencia de datos faltantes, el cual se evidencia a continuación:</p>
<ul class="simple">
<li><p>Cantidad de años de la empresa     <code class="docutils literal notranslate"><span class="pre">19</span></code></p></li>
<li><p>Razón corriente                    <code class="docutils literal notranslate"><span class="pre">57</span></code></p></li>
<li><p>Rotación cartera                  <code class="docutils literal notranslate"><span class="pre">592</span></code></p></li>
<li><p>Generación Efectivo                <code class="docutils literal notranslate"><span class="pre">34</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">missing_data</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># Mostrar las columnas que tienen valores faltantes</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cantidad de datos faltantes por columna:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">missing_data</span><span class="p">[</span><span class="n">missing_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cantidad de datos faltantes por columna:
Cantidad de años de la empresa     19
Razón corriente                    57
Rotación cartera                  592
Generación Efectivo                34
dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Para las variables con datos faltantes se debe realizar un proceso de imputación y teniendo en cuenta la naturaleza no paramétrica de la distribución de la mayoría de variables involucradas, se implementará el método <code class="docutils literal notranslate"><span class="pre">IterativeImputer</span></code> o <code class="docutils literal notranslate"><span class="pre">imputación</span> <span class="pre">iterativa</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Seleccionar solo las columnas numéricas para imputar</span>
<span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>

<span class="c1"># Aplicar IterativeImputer solo a las columnas numéricas</span>
<span class="n">imputer</span> <span class="o">=</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_nearest_features</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">imputation_order</span><span class="o">=</span><span class="s1">&#39;ascending&#39;</span><span class="p">)</span>
<span class="n">data_filter_imputed</span> <span class="o">=</span> <span class="n">data_filter</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">numeric_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data_filter</span><span class="p">[</span><span class="n">numeric_columns</span><span class="p">])</span>

<span class="c1"># Verificar la cantidad de datos faltantes después de la imputación</span>
<span class="n">missing_data_after_imputation</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cantidad de datos faltantes después de la imputación:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">missing_data_after_imputation</span><span class="p">[</span><span class="n">missing_data_after_imputation</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

<span class="c1"># Calcular cuántos valores fueron imputados (si se imputaron valores)</span>
<span class="n">imputados</span> <span class="o">=</span> <span class="n">missing_data</span> <span class="o">-</span> <span class="n">missing_data_after_imputation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cantidad de valores imputados por columna:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">imputados</span><span class="p">[</span><span class="n">imputados</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cantidad de datos faltantes después de la imputación:
Series([], dtype: int64)

Cantidad de valores imputados por columna:
Cantidad de años de la empresa     19
Razón corriente                    57
Rotación cartera                  592
Generación Efectivo                34
dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
<section id="modelo-de-base-xgboost">
<h2>Modelo de base XGBoost<a class="headerlink" href="#modelo-de-base-xgboost" title="Link to this heading">#</a></h2>
<p>Durante la división de los datos se asigna a la variable objetivo <code class="docutils literal notranslate"><span class="pre">y</span></code> la columna a predecir <code class="docutils literal notranslate"><span class="pre">FDC_FLC_categoria</span></code> y se excluye de la variables predictoras las columnas <code class="docutils literal notranslate"><span class="pre">NIT</span></code>, <code class="docutils literal notranslate"><span class="pre">FDC_FLC_categoria</span></code> y <code class="docutils literal notranslate"><span class="pre">Fecha</span> <span class="pre">de</span> <span class="pre">Corte</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Separar las características (X) y la etiqueta (y)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

<span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">y_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>En el proceso de preprocesamiento de los datos se realiza la estandarización de las variables numéricas con el método <code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code> y la codificación de las variables categóricas con el método <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># Columnas numéricas</span>
<span class="n">categorical_cols</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># Columnas categóricas</span>

<span class="c1"># Estandarización para las variables numéricas</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>  <span class="c1"># Estandarización</span>
<span class="p">])</span>

<span class="c1"># One-Hot Encoding para las variables categóricas</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>  <span class="c1"># Imputar valores faltantes en las variables categóricas</span>
    <span class="p">(</span><span class="s1">&#39;onehot&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>  <span class="c1"># One-Hot Encoding</span>
<span class="p">])</span>

<span class="c1"># Preprocesador con ColumnTransformer que aplica las transformaciones correspondientes a cada tipo de columna</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_cols</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_cols</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>La familia a utilizar de los modelos <code class="docutils literal notranslate"><span class="pre">Extreme</span> <span class="pre">Gradient</span> <span class="pre">Boosting</span></code> o <code class="docutils literal notranslate"><span class="pre">XGBoost</span></code> será de tipo multiclase y en esta caso, multi:softmax es el parámetro que debe recibir la función.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">xgb_model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;multi:softmax&#39;</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Crear el pipeline completo</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;xgbclassifier&#39;</span><span class="p">,</span> <span class="n">xgb_model</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Se realiza una busqueda para el proceso de hiperparametrización de los mejores parámetros para el modelo. Se establecen los siguientes:</p>
<ul class="simple">
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__n_estimators</span></code>’: Define cuántos árboles componen el modelo de clasificación.</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__learning_rate</span></code>’: Controla la magnitud de los ajustes en cada iteración.</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__max_depth</span></code>’: Limita la profundidad máxima de cada árbol, evitando sobreajuste.</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__subsample</span></code>’: Porcentaje de datos utilizados para entrenar cada árbol, mejora generalización.</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__colsample_bytree</span></code>’: Proporción de características seleccionadas aleatoriamente por cada árbol.</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__gamma</span></code>’: Establece penalización para árboles más complejos, reduciendo sobreajuste.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;xgbclassifier__n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>  <span class="c1"># Número de árboles</span>
    <span class="s1">&#39;xgbclassifier__learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>  <span class="c1"># Tasa de aprendizaje</span>
    <span class="s1">&#39;xgbclassifier__max_depth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>  <span class="c1"># Profundidad máxima del árbol</span>
    <span class="s1">&#39;xgbclassifier__subsample&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>  <span class="c1"># Submuestreo</span>
    <span class="s1">&#39;xgbclassifier__colsample_bytree&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>  <span class="c1"># Fracción de características por árbol</span>
    <span class="s1">&#39;xgbclassifier__gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>  <span class="c1"># Penalización de complejidad</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Busqueda en red para mejores parámetros arrojó la siguiente lista a nibel general y no separado por año:</p>
<ul class="simple">
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__n_estimators</span></code>’: 0.8</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__learning_rate</span></code>’: 0</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__max_depth</span></code>’: 0.1</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__subsample</span></code>’: 5</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__colsample_bytree</span></code>’: 200</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__gamma</span></code>’: 0.8</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>

<span class="c1"># Paso 8: Ajustar el modelo con GridSearchCV</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Paso 9: Imprimir los mejores hiperparámetros encontrados</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mejores hiperparámetros encontrados:&quot;</span><span class="p">,</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting 5 folds for each of 216 candidates, totalling 1080 fits
Mejores hiperparámetros encontrados: {&#39;xgbclassifier__colsample_bytree&#39;: 0.8, &#39;xgbclassifier__gamma&#39;: 0, &#39;xgbclassifier__learning_rate&#39;: 0.1, &#39;xgbclassifier__max_depth&#39;: 5, &#39;xgbclassifier__n_estimators&#39;: 200, &#39;xgbclassifier__subsample&#39;: 0.8}
</pre></div>
</div>
</div>
</div>
<p><strong>Se muestra a continuación los mejores hiperparámetros por año para el modelo XGBoost:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">2018</span></code>: ‘xgbclassifier__colsample_bytree’: 1.0, ‘xgbclassifier__gamma’: 0.1, ‘xgbclassifier__learning_rate’: 0.01, ‘xgbclassifier__max_depth’: 5, ‘xgbclassifier__n_estimators’: 100, ‘xgbclassifier__subsample’: 0.8</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2019</span></code>: ‘xgbclassifier__colsample_bytree’: 0.8, ‘xgbclassifier__gamma’: 0.1, ‘xgbclassifier__learning_rate’: 0.01, ‘xgbclassifier__max_depth’: 7, ‘xgbclassifier__n_estimators’: 200, ‘xgbclassifier__subsample’: 0.8</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2020</span></code>: ‘xgbclassifier__colsample_bytree’: 1.0, ‘xgbclassifier__gamma’: 0.2, ‘xgbclassifier__learning_rate’: 0.1, ‘xgbclassifier__max_depth’: 5, ‘xgbclassifier__n_estimators’: 100, ‘xgbclassifier__subsample’: 0.8</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2021</span></code>: ‘xgbclassifier__colsample_bytree’: 1.0, ‘xgbclassifier__gamma’: 0.1, ‘xgbclassifier__learning_rate’: 0.1, ‘xgbclassifier__max_depth’: 5, ‘xgbclassifier__n_estimators’: 100, ‘xgbclassifier__subsample’: 0.8</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2022</span></code>: ‘xgbclassifier__colsample_bytree’: 1.0, ‘xgbclassifier__gamma’: 0.1, ‘xgbclassifier__learning_rate’: 0.1, ‘xgbclassifier__max_depth’: 5, ‘xgbclassifier__n_estimators’: 100, ‘xgbclassifier__subsample’: 0.8</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2023</span></code>: ‘xgbclassifier__colsample_bytree’: 0.8, ‘xgbclassifier__gamma’: 0.1, ‘xgbclassifier__learning_rate’: 0.1, ‘xgbclassifier__max_depth’: 5, ‘xgbclassifier__n_estimators’: 100, ‘xgbclassifier__subsample’: 1.0</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dividir los datos por año para entrenamiento secuencial</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)):</span>
    <span class="n">train_years</span> <span class="o">=</span> <span class="n">years</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># Datos de entrenamiento hasta el año i-1</span>
    <span class="n">test_year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="c1"># Año para la prueba</span>

    <span class="c1"># Filtrar los datos de entrenamiento y prueba</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

    <span class="c1"># Codificar las etiquetas de la variable objetivo para entrenamiento</span>
    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>  <span class="c1"># Codificar etiquetas de entrenamiento</span>
    <span class="n">y_test_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>  <span class="c1"># Codificar etiquetas de prueba</span>

    <span class="c1"># Configurar el GridSearchCV</span>
    <span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">)</span>

    <span class="c1"># Ajustar el modelo con los datos de entrenamiento</span>
    <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mejores hiperparámetros para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Evaluar el modelo en los datos de prueba</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>  <span class="c1"># El mejor modelo encontrado por GridSearchCV</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>  <span class="c1"># Predicciones en el conjunto de prueba</span>
    <span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>  <span class="c1"># Calcular la precisión</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precisión en el conjunto de prueba para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">test_accuracy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting 5 folds for each of 216 candidates, totalling 1080 fits

Mejores hiperparámetros para el año 2018.0: {&#39;xgbclassifier__colsample_bytree&#39;: 1.0, &#39;xgbclassifier__gamma&#39;: 0.1, &#39;xgbclassifier__learning_rate&#39;: 0.01, &#39;xgbclassifier__max_depth&#39;: 5, &#39;xgbclassifier__n_estimators&#39;: 100, &#39;xgbclassifier__subsample&#39;: 0.8}
Precisión en el conjunto de prueba para el año 2018.0: 0.4879843060323688
Fitting 5 folds for each of 216 candidates, totalling 1080 fits

Mejores hiperparámetros para el año 2019.0: {&#39;xgbclassifier__colsample_bytree&#39;: 0.8, &#39;xgbclassifier__gamma&#39;: 0.1, &#39;xgbclassifier__learning_rate&#39;: 0.01, &#39;xgbclassifier__max_depth&#39;: 7, &#39;xgbclassifier__n_estimators&#39;: 200, &#39;xgbclassifier__subsample&#39;: 0.8}
Precisión en el conjunto de prueba para el año 2019.0: 0.5077680939749906
Fitting 5 folds for each of 216 candidates, totalling 1080 fits

Mejores hiperparámetros para el año 2020.0: {&#39;xgbclassifier__colsample_bytree&#39;: 1.0, &#39;xgbclassifier__gamma&#39;: 0.2, &#39;xgbclassifier__learning_rate&#39;: 0.1, &#39;xgbclassifier__max_depth&#39;: 5, &#39;xgbclassifier__n_estimators&#39;: 100, &#39;xgbclassifier__subsample&#39;: 0.8}
Precisión en el conjunto de prueba para el año 2020.0: 0.5025720164609053
Fitting 5 folds for each of 216 candidates, totalling 1080 fits

Mejores hiperparámetros para el año 2021.0: {&#39;xgbclassifier__colsample_bytree&#39;: 1.0, &#39;xgbclassifier__gamma&#39;: 0.1, &#39;xgbclassifier__learning_rate&#39;: 0.1, &#39;xgbclassifier__max_depth&#39;: 5, &#39;xgbclassifier__n_estimators&#39;: 100, &#39;xgbclassifier__subsample&#39;: 0.8}
Precisión en el conjunto de prueba para el año 2021.0: 0.5151823579304495
Fitting 5 folds for each of 216 candidates, totalling 1080 fits

Mejores hiperparámetros para el año 2022.0: {&#39;xgbclassifier__colsample_bytree&#39;: 1.0, &#39;xgbclassifier__gamma&#39;: 0.1, &#39;xgbclassifier__learning_rate&#39;: 0.1, &#39;xgbclassifier__max_depth&#39;: 5, &#39;xgbclassifier__n_estimators&#39;: 100, &#39;xgbclassifier__subsample&#39;: 0.8}
Precisión en el conjunto de prueba para el año 2022.0: 0.5260575296108291
Fitting 5 folds for each of 216 candidates, totalling 1080 fits

Mejores hiperparámetros para el año 2023.0: {&#39;xgbclassifier__colsample_bytree&#39;: 0.8, &#39;xgbclassifier__gamma&#39;: 0.1, &#39;xgbclassifier__learning_rate&#39;: 0.1, &#39;xgbclassifier__max_depth&#39;: 5, &#39;xgbclassifier__n_estimators&#39;: 100, &#39;xgbclassifier__subsample&#39;: 1.0}
Precisión en el conjunto de prueba para el año 2023.0: 0.5541423169474046
</pre></div>
</div>
</div>
</div>
<p><strong>Mejores hiperparámetros promedio a utilizar en el modelo XGBoost dado la verificación por año</strong></p>
<ul class="simple">
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__n_estimators</span></code>’: 1</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__learning_rate</span></code>’: 0.1</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__max_depth</span></code>’: 0.1</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__subsample</span></code>’: 5</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__colsample_bytree</span></code>’: 100</p></li>
<li><p>‘<code class="docutils literal notranslate"><span class="pre">xgbclassifier__gamma</span></code>’: 0.8</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># modelo XGBoost para clasificación multiclase</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;multi:softmax&#39;</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_encoded</span><span class="p">)))</span>

<span class="c1"># pipeline completo</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;xgbclassifier&#39;</span><span class="p">,</span> <span class="n">xgb_model</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ajustar los mejores hiperparámetros</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">xgbclassifier__n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">xgbclassifier__learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">xgbclassifier__max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">xgbclassifier__subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="n">xgbclassifier__colsample_bytree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">xgbclassifier__gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Dividir los datos por año para entrenamiento secuencial</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="c1"># Resultados para almacenar las métricas</span>
<span class="c1"># Resultados para almacenar las métricas</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;ROC AUC&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;F1 Score&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Classification Report&#39;</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<section id="lanzamiento-del-modelo-de-clasificacion-de-base-xgboost">
<h3><strong>Lanzamiento del modelo de clasificación de base XGBoost</strong><a class="headerlink" href="#lanzamiento-del-modelo-de-clasificacion-de-base-xgboost" title="Link to this heading">#</a></h3>
<p>Se obtiene la siguiente información del entrenamiento o validación secuencial del modelo de base XGBoost:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Año</span> <span class="pre">2018:</span> </code></p></li>
</ol>
<p>Para el año 2018 se tiene que las variabes que más influyen en la clasificación de las clases son:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">num__Generación</span> <span class="pre">Efectivo:</span></code> 0.0317</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num__ROA</span></code>: 0.0302</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat__Departamento</span></code> de la dirección del domicilio: 0.0287</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num__ROE</span></code>: 0.0212</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat__Departamento</span></code> de la dirección del domicilio: 0.0207</p></li>
</ul>
<p><strong>Matriz de confusión para 2018</strong></p>
<ul class="simple">
<li><p>Total de Predicciones Correctas: 326</p></li>
<li><p>Total de Predicciones Incorrectas: 269</p></li>
<li><p>Número Total de Predicciones: 763</p></li>
<li><p>Número de Verdaderos Positivos: 428 (categoría [0, 0.67))</p></li>
<li><p>Número de Falsos Positivos: 256</p></li>
<li><p>Número de Falsos Negativos: 32</p></li>
<li><p>Número de Verdaderos Negativos: 441 (categoría [1, ∞))</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p><code class="docutils literal notranslate"><span class="pre">Año</span> <span class="pre">2019:</span></code></p></li>
</ol>
<p>Para el año 2019, las variables que más influyen en la clasificación de las clases son:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">num__ROA</span></code>: 0.0357</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">num__Generación</span> <span class="pre">Efectivo:</span></code> 0.0328</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat__Estado</span> <span class="pre">actual_ACUERDO</span> <span class="pre">DE</span> <span class="pre">REESTRUCTURACIÓN:</span></code> 0.0208</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat__Departamento</span> <span class="pre">de</span> <span class="pre">la</span> <span class="pre">dirección</span> <span class="pre">del</span> <span class="pre">domicilio</span></code>: 0.0208</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat__Clasificación</span> <span class="pre">Industrial</span> <span class="pre">Internacional</span> <span class="pre">Un:</span></code> 0.0195</p></li>
</ul>
<p>Matriz de Confusión para 2019:</p>
<ul class="simple">
<li><p>Total de Predicciones Correctas: 532</p></li>
<li><p>Total de Predicciones Incorrectas: 295</p></li>
<li><p>Número Total de Predicciones: 832</p></li>
<li><p>Número de Verdaderos Positivos: 191 (categoría [0, 0.67))</p></li>
<li><p>Número de Falsos Positivos: 554</p></li>
<li><p>Número de Falsos Negativos: 112</p></li>
<li><p>Número de Verdaderos Negativos: 294 (categoría [1, ∞))</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)):</span>
    <span class="n">train_years</span> <span class="o">=</span> <span class="n">years</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># Datos de entrenamiento hasta el año i-1</span>
    <span class="n">test_year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="c1"># Año para la prueba</span>

    <span class="c1"># Filtrar los datos de entrenamiento y prueba</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

    <span class="c1"># Codificar las etiquetas de la variable objetivo para entrenamiento</span>
    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>  <span class="c1"># Codificar etiquetas de entrenamiento</span>
    <span class="n">y_test_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>  <span class="c1"># Codificar etiquetas de prueba</span>

    <span class="c1"># Ajustar el modelo con los datos de entrenamiento y los mejores hiperparámetros</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>

    <span class="c1"># Realizar predicciones</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Calcular las métricas</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">class_report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="c1"># Almacenar resultados</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_year</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Classification Report&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_report</span><span class="p">)</span>

    <span class="c1"># Graficar la matriz de confusión</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confusion Matrix for Year </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Graficar la curva ROC</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Usamos la clase 1 como ejemplo</span>
    <span class="n">roc_auc_val</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC curve (area = </span><span class="si">{</span><span class="n">roc_auc_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROC Curve for Year </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Mostrar las variables más importantes para el año actual</span>
    <span class="n">feature_importances</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;xgbclassifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

    <span class="c1"># Obtener los nombres de las características del preprocesador</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">input_features</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Crear un DataFrame con las importancias de características</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Feature&#39;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
        <span class="s1">&#39;Importance&#39;</span><span class="p">:</span> <span class="n">feature_importances</span>
    <span class="p">})</span>

    <span class="c1"># Ordenar por la importancia (de mayor a menor)</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Mostrar las 10 características más importantes</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Variables más significativas para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">importance_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/06c4947f00c879999646454154f4f316240de8bef76f879a5281b72cfea6db35.png" src="_images/06c4947f00c879999646454154f4f316240de8bef76f879a5281b72cfea6db35.png" />
<img alt="_images/5852fd064c96b2730612f4af65a4fd024cb265c66007b7e07bcab06e92f4ef5b.png" src="_images/5852fd064c96b2730612f4af65a4fd024cb265c66007b7e07bcab06e92f4ef5b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables más significativas para el año 2018.0:
                                              Feature  Importance
5                            num__Generación Efectivo    0.031658
3                                            num__ROA    0.030222
44  cat__Departamento de la dirección del domicili...    0.028746
4                                            num__ROE    0.021155
26  cat__Departamento de la dirección del domicili...    0.020669
50  cat__Clasificación Industrial Internacional Un...    0.020080
24  cat__Tipo societario_08. SOCIEDAD POR ACCIONES...    0.019799
7      cat__Estado actual_ACUERDO DE REESTRUCTURACIÓN    0.019469
2                               num__Rotación cartera    0.019309
28  cat__Departamento de la dirección del domicili...    0.018955
</pre></div>
</div>
<img alt="_images/ef1c9daa0cf650748740054c3bf29d90e60ef4eadaa132c3e248afd0408e5950.png" src="_images/ef1c9daa0cf650748740054c3bf29d90e60ef4eadaa132c3e248afd0408e5950.png" />
<img alt="_images/c579c2bff7d5feb2fe51540bb4aa8f6f2ca53f7257482c6190127e28940d3d87.png" src="_images/c579c2bff7d5feb2fe51540bb4aa8f6f2ca53f7257482c6190127e28940d3d87.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables más significativas para el año 2019.0:
                                              Feature  Importance
3                                            num__ROA    0.035737
5                            num__Generación Efectivo    0.032806
7      cat__Estado actual_ACUERDO DE REESTRUCTURACIÓN    0.020807
31  cat__Departamento de la dirección del domicili...    0.020778
45  cat__Departamento de la dirección del domicili...    0.020769
61  cat__Clasificación Industrial Internacional Un...    0.019503
38  cat__Departamento de la dirección del domicili...    0.019145
4                                            num__ROE    0.018530
29  cat__Departamento de la dirección del domicili...    0.018518
2                               num__Rotación cartera    0.018455
</pre></div>
</div>
<img alt="_images/375fef5f13a526f89c5a9efde7f29116319abc75e40228d0538fbdc8b22f3261.png" src="_images/375fef5f13a526f89c5a9efde7f29116319abc75e40228d0538fbdc8b22f3261.png" />
<img alt="_images/83b83c271a4f5a578e6306a0310340a650e52431537dec5e8e5a7fd476b5d0ae.png" src="_images/83b83c271a4f5a578e6306a0310340a650e52431537dec5e8e5a7fd476b5d0ae.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables más significativas para el año 2020.0:
                                              Feature  Importance
3                                            num__ROA    0.042599
5                            num__Generación Efectivo    0.039586
58  cat__Clasificación Industrial Internacional Un...    0.022183
21       cat__Tipo societario_02. SUCURSAL EXTRANJERA    0.019245
59  cat__Clasificación Industrial Internacional Un...    0.017970
1                                num__Razón corriente    0.017614
60  cat__Clasificación Industrial Internacional Un...    0.017424
57  cat__Clasificación Industrial Internacional Un...    0.017337
4                                            num__ROE    0.017284
33  cat__Departamento de la dirección del domicili...    0.017283
</pre></div>
</div>
<img alt="_images/2bc789c4c439324fdd167cdc194c3fd18193e9ba2f92111cb70389a7be094b78.png" src="_images/2bc789c4c439324fdd167cdc194c3fd18193e9ba2f92111cb70389a7be094b78.png" />
<img alt="_images/a6a87f619d7513010e064b93405a826ff0711413a46e3ec9c7d4b5c545cee9df.png" src="_images/a6a87f619d7513010e064b93405a826ff0711413a46e3ec9c7d4b5c545cee9df.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables más significativas para el año 2021.0:
                                              Feature  Importance
3                                            num__ROA    0.049371
5                            num__Generación Efectivo    0.045996
21       cat__Tipo societario_02. SUCURSAL EXTRANJERA    0.022456
58  cat__Clasificación Industrial Internacional Un...    0.020356
59  cat__Clasificación Industrial Internacional Un...    0.017725
1                                num__Razón corriente    0.017721
62  cat__Clasificación Industrial Internacional Un...    0.017433
4                                            num__ROE    0.017010
40  cat__Departamento de la dirección del domicili...    0.016884
23     cat__Tipo societario_04. SOCIEDAD EN COMANDITA    0.016851
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
</pre></div>
</div>
<img alt="_images/fa922515a6d479151e816830cb137bdde0c42a63e61410573ad20f142c0f19a0.png" src="_images/fa922515a6d479151e816830cb137bdde0c42a63e61410573ad20f142c0f19a0.png" />
<img alt="_images/ccbcfde3addbe7f01b4a4afd27703cb5070872c7223a29acacf72abc6d414fa1.png" src="_images/ccbcfde3addbe7f01b4a4afd27703cb5070872c7223a29acacf72abc6d414fa1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables más significativas para el año 2022.0:
                                              Feature  Importance
3                                            num__ROA    0.056461
5                            num__Generación Efectivo    0.055757
21       cat__Tipo societario_02. SUCURSAL EXTRANJERA    0.022677
58  cat__Clasificación Industrial Internacional Un...    0.021206
59  cat__Clasificación Industrial Internacional Un...    0.018234
1                                num__Razón corriente    0.017467
23     cat__Tipo societario_04. SOCIEDAD EN COMANDITA    0.017084
57  cat__Clasificación Industrial Internacional Un...    0.016877
6                           cat__Estado actual_ACTIVA    0.016688
2                               num__Rotación cartera    0.016435
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
</pre></div>
</div>
<img alt="_images/e57657961d5a4c76f4eedb8b6ed2ddfaf96122ffcd3073f3ac9a072bace39bb6.png" src="_images/e57657961d5a4c76f4eedb8b6ed2ddfaf96122ffcd3073f3ac9a072bace39bb6.png" />
<img alt="_images/217c6f6491bf7cf418be83737dcf853e712b800a7b00186ca58c0d3cba31e08a.png" src="_images/217c6f6491bf7cf418be83737dcf853e712b800a7b00186ca58c0d3cba31e08a.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables más significativas para el año 2023.0:
                                              Feature  Importance
5                            num__Generación Efectivo    0.061721
3                                            num__ROA    0.060123
21       cat__Tipo societario_02. SUCURSAL EXTRANJERA    0.018980
58  cat__Clasificación Industrial Internacional Un...    0.018400
59  cat__Clasificación Industrial Internacional Un...    0.017878
6                           cat__Estado actual_ACTIVA    0.017624
14  cat__Concepto del Revisor fiscal en su orme_03...    0.016538
57  cat__Clasificación Industrial Internacional Un...    0.016499
1                                num__Razón corriente    0.016434
27  cat__Tipo societario_08. SOCIEDAD POR ACCIONES...    0.016397
</pre></div>
</div>
</div>
</div>
<p><strong>Métricas del modelo base XGBoost</strong></p>
<p>Si bien el modelo tiende a presentar un incremento considerable en la métrica de clasificación AUC-ROC no es adecuada u óptima con referencia a precision, recall, f1-score, por lo que requiere un ajuste en el clasificador.</p>
<p><code class="docutils literal notranslate"><span class="pre">Año</span> <span class="pre">2018:</span></code></p>
<ul class="simple">
<li><p>Accuracy: 41.05%</p></li>
<li><p>ROC AUC: 0.6768</p></li>
<li><p>F1 Score: 0.3993</p></li>
<li><p>Precision: 0.4018</p></li>
<li><p>Recall: 0.4105</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Año</span> <span class="pre">2019:</span></code></p>
<ul class="simple">
<li><p>Accuracy: 43.75%</p></li>
<li><p>ROC AUC: 0.7126</p></li>
<li><p>F1 Score: 0.4252</p></li>
<li><p>Precision: 0.4245</p></li>
<li><p>Recall: 0.4375</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Año</span> <span class="pre">2020:</span></code></p>
<ul class="simple">
<li><p>Accuracy: 43.60%</p></li>
<li><p>ROC AUC: 0.7171</p></li>
<li><p>F1 Score: 0.4213</p></li>
<li><p>Precision: 0.4275</p></li>
<li><p>Recall: 0.4360</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Año</span> <span class="pre">2021:</span></code></p>
<ul class="simple">
<li><p>Accuracy: 44.90%</p></li>
<li><p>ROC AUC: 0.7291</p></li>
<li><p>F1 Score: 0.4295</p></li>
<li><p>Precision: 0.4364</p></li>
<li><p>Recall: 0.4490</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Año</span> <span class="pre">2022:</span></code></p>
<ul class="simple">
<li><p>Accuracy: 45.41%</p></li>
<li><p>ROC AUC: 0.7234</p></li>
<li><p>F1 Score: 0.4336</p></li>
<li><p>Precision: 0.4355</p></li>
<li><p>Recall: 0.4541</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Año</span> <span class="pre">2023:</span></code></p>
<ul class="simple">
<li><p>Accuracy: 46.48%</p></li>
<li><p>ROC AUC: 0.7418</p></li>
<li><p>F1 Score: 0.4447</p></li>
<li><p>Precision: 0.4438</p></li>
<li><p>Recall: 0.4648</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-eca1129c-8876-4bd5-a971-dc482bd282f9" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Year</th>
      <th>Accuracy</th>
      <th>ROC AUC</th>
      <th>F1 Score</th>
      <th>Precision</th>
      <th>Recall</th>
      <th>Confusion Matrix</th>
      <th>Classification Report</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2018.0</td>
      <td>0.410495</td>
      <td>0.676761</td>
      <td>0.399334</td>
      <td>0.401823</td>
      <td>0.410495</td>
      <td>[[428, 256, 1, 32, 441], [176, 356, 3, 92, 254...</td>
      <td>precision    recall  f1-score   ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019.0</td>
      <td>0.437476</td>
      <td>0.712623</td>
      <td>0.425234</td>
      <td>0.424524</td>
      <td>0.437476</td>
      <td>[[532, 295, 2, 47, 632], [191, 554, 2, 112, 29...</td>
      <td>precision    recall  f1-score   ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020.0</td>
      <td>0.436043</td>
      <td>0.717062</td>
      <td>0.421313</td>
      <td>0.427533</td>
      <td>0.436043</td>
      <td>[[423, 353, 3, 86, 545], [126, 653, 3, 176, 34...</td>
      <td>precision    recall  f1-score   ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021.0</td>
      <td>0.449025</td>
      <td>0.729090</td>
      <td>0.429502</td>
      <td>0.436361</td>
      <td>0.449025</td>
      <td>[[445, 312, 0, 68, 629], [126, 751, 2, 183, 29...</td>
      <td>precision    recall  f1-score   ...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2022.0</td>
      <td>0.454146</td>
      <td>0.723446</td>
      <td>0.433580</td>
      <td>0.435473</td>
      <td>0.454146</td>
      <td>[[470, 335, 0, 50, 630], [134, 693, 0, 134, 31...</td>
      <td>precision    recall  f1-score   ...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2023.0</td>
      <td>0.464765</td>
      <td>0.741806</td>
      <td>0.444719</td>
      <td>0.443802</td>
      <td>0.464765</td>
      <td>[[500, 357, 0, 48, 662], [110, 807, 0, 172, 27...</td>
      <td>precision    recall  f1-score   ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-eca1129c-8876-4bd5-a971-dc482bd282f9')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-eca1129c-8876-4bd5-a971-dc482bd282f9 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-eca1129c-8876-4bd5-a971-dc482bd282f9');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-18548dd5-7afc-46d2-8052-596b4d905fdc">
  <button class="colab-df-quickchart" onclick="quickchart('df-18548dd5-7afc-46d2-8052-596b4d905fdc')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-18548dd5-7afc-46d2-8052-596b4d905fdc button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Guardar el modelo y las métricas en un archivo pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;xgboost_model.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># Guardar el dataframe de resultados</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;model_results.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Graficamente se puede observar la estructura creada del primer árbol de clasificación que se realizó para mostrar de qué manera funciona XGBoost</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extraer el modelo XGBoost ajustado del pipeline</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;xgbclassifier&#39;</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># Tamaño de la figura</span>
<span class="n">xgb</span><span class="o">.</span><span class="n">plot_tree</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="n">num_trees</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># num_trees=0 selecciona el primer árbol</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 2000x1000 with 0 Axes&gt;
</pre></div>
</div>
<img alt="_images/5c27a667a6f54f245e6323799565b99affb1081c61580e3e12c3ee88767694be.png" src="_images/5c27a667a6f54f245e6323799565b99affb1081c61580e3e12c3ee88767694be.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># Ajusta el número de árboles que deseas visualizar</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">xgb</span><span class="o">.</span><span class="n">plot_tree</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="n">num_trees</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Árbol </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 2000x1000 with 0 Axes&gt;
</pre></div>
</div>
<img alt="_images/a6840124bc4989ff5ff76699ba6e770da9af74573c0e676aa1b43bdd94ba6b5c.png" src="_images/a6840124bc4989ff5ff76699ba6e770da9af74573c0e676aa1b43bdd94ba6b5c.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 2000x1000 with 0 Axes&gt;
</pre></div>
</div>
<img alt="_images/f831fc5705ef991cc39c3abba9cfbf536246350cb44796abe745435881c920c1.png" src="_images/f831fc5705ef991cc39c3abba9cfbf536246350cb44796abe745435881c920c1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 2000x1000 with 0 Axes&gt;
</pre></div>
</div>
<img alt="_images/68ebfe09683bee0f744a8c466ef683d85d6fd4ae52c31f8dd9330a4abe66c748.png" src="_images/68ebfe09683bee0f744a8c466ef683d85d6fd4ae52c31f8dd9330a4abe66c748.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 2000x1000 with 0 Axes&gt;
</pre></div>
</div>
<img alt="_images/ab480250fc2f182c9f4e47af9c791c16f9fc864a2f318014bea3dcac19c7501c.png" src="_images/ab480250fc2f182c9f4e47af9c791c16f9fc864a2f318014bea3dcac19c7501c.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 2000x1000 with 0 Axes&gt;
</pre></div>
</div>
<img alt="_images/57882e2713ef7f87ae671c32524926e7508faaf3bca9cffd8ad76e1ec7a42a68.png" src="_images/57882e2713ef7f87ae671c32524926e7508faaf3bca9cffd8ad76e1ec7a42a68.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="kn">import</span> <span class="nn">graphviz</span>

<span class="c1"># Extraer el modelo XGBoost ajustado del pipeline</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;xgbclassifier&#39;</span><span class="p">]</span>

<span class="c1"># Generar la visualización del primer árbol del modelo</span>
<span class="n">dot</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">to_graphviz</span><span class="p">(</span><span class="n">xgb_model</span><span class="p">,</span> <span class="n">num_trees</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># num_trees=0 selecciona el primer árbol</span>

<span class="c1"># Renderizar el árbol con Graphviz</span>
<span class="n">dot</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">cleanup</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Guardar la imagen como archivo PNG</span>
<span class="n">dot</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s1">&#39;tree&#39;</span><span class="p">)</span>  <span class="c1"># Abrir la imagen generada</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;tree.pdf&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="importancia-de-las-variables">
<h3>Importancia de las variables<a class="headerlink" href="#importancia-de-las-variables" title="Link to this heading">#</a></h3>
<p>Se realiza el entrenamiento y verificación de las variables que más aportan a la clasificación de las categorías en los perioddo 2017 a 2023. Se observa que Las barras horizontales representan el peso relativo de cada variable en el modelo en diferentes períodos, destacando:</p>
<ol class="arabic simple">
<li><p>Cantidad de años de la empresa: Es consistentemente la variable más importante, con una alta influencia en todos los años analizados.</p></li>
<li><p>Razón corriente y Rotación cartera: También tienen un impacto relevante, aunque con menor peso en comparación con la anterior.</p></li>
<li><p>ROA (Rentabilidad sobre activos) y ROE (Rentabilidad sobre capital): Mantienen un peso intermedio pero constante en los años</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">all_categories</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">all_categories</span><span class="p">)</span>

<span class="c1"># Validación secuencial</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)):</span>
    <span class="n">train_years</span> <span class="o">=</span> <span class="n">years</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="n">test_year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>

    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>

    <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;xgbclassifier&#39;</span><span class="p">]</span>
    <span class="n">feature_importance</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">feature_importances_</span>

    <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Variable&#39;</span><span class="p">:</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="s1">&#39;Importancia&#39;</span><span class="p">:</span> <span class="n">feature_importance</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
    <span class="p">})</span>

    <span class="n">importance</span><span class="p">[</span><span class="s1">&#39;Año&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_year</span>
    <span class="n">importance_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">importance_df</span><span class="p">,</span> <span class="n">importance</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Graficar la importancia de las variables para cada año</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">importance_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Importancia&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Año&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Importancia de las Variables por Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/08b17fda74adccaf25e84d90ac64634af1e0645c49d20e6a4d5d2352eaeca512.png" src="_images/08b17fda74adccaf25e84d90ac64634af1e0645c49d20e6a4d5d2352eaeca512.png" />
</div>
</div>
<p>La gráfica muestra la tendencia de la importancia promedio de las variables en el modelo durante el periodo 2018-2023. Algunas observaciones clave son:</p>
<ol class="arabic simple">
<li><p>Variables con aumento constante:</p>
<ul class="simple">
<li><p>Cantidad de años de la empresa y Estado actual muestran una tendencia creciente, consolidándose como las variables más importantes en los últimos años.</p></li>
</ul>
</li>
<li><p>Estabilidad relativa:</p>
<ul class="simple">
<li><p>Razón corriente, Rotación cartera, ROA y ROE mantienen una importancia consistente a lo largo del tiempo, sin cambios significativos.</p></li>
</ul>
</li>
<li><p>Impacto mínimo o decreciente:</p>
<ul class="simple">
<li><p>Variables como Tipo societario y Clasificación industrial internacional uniforme (CIIU) presentan importancia nula o mínima, lo que indica que su relevancia para el modelo es marginal o inexistente.</p></li>
</ul>
</li>
<li><p>Fluctuaciones menores:</p>
<ul class="simple">
<li><p>Algunas variables, como Generación de efectivo y Concepto del Revisor fiscal en su informe, muestran ligeros cambios de importancia entre años, pero su influencia global sigue siendo moderada.</p></li>
</ul>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Crear un DataFrame para almacenar la importancia promedio por variable a lo largo de los años</span>
<span class="n">importance_trend_df</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Año&#39;</span><span class="p">,</span> <span class="s1">&#39;Variable&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;Importancia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Graficar la tendencia de la importancia de las variables</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Graficar múltiples líneas para cada variable</span>
<span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">importance_trend_df</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">variable_data</span> <span class="o">=</span> <span class="n">importance_trend_df</span><span class="p">[</span><span class="n">importance_trend_df</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">variable</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">variable_data</span><span class="p">[</span><span class="s1">&#39;Año&#39;</span><span class="p">],</span> <span class="n">variable_data</span><span class="p">[</span><span class="s1">&#39;Importancia&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="c1"># Personalización de la gráfica</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Tendencia de la Importancia de las Variables por Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Importancia Promedio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Variables&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/61846f7ec857c0e5e926ae79b21ec56e0b9e85ec4b35694ad25288d81691fac2.png" src="_images/61846f7ec857c0e5e926ae79b21ec56e0b9e85ec4b35694ad25288d81691fac2.png" />
</div>
</div>
</section>
<section id="seleccion-de-empresas-por-categoria">
<h3>Selección de empresas por categoría<a class="headerlink" href="#seleccion-de-empresas-por-categoria" title="Link to this heading">#</a></h3>
<p>Se elige al azar una empresa de cada categoría para analizar que variables infuyeron en su clasificación.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">categorias</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="c1"># Seleccionar una empresa aleatoria por cada categoría</span>
<span class="n">empresas_aleatorias</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">categoria</span> <span class="ow">in</span> <span class="n">categorias</span><span class="p">:</span>
    <span class="n">empresas_categoria</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">categoria</span><span class="p">]</span>
    <span class="n">empresa_aleatoria</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">empresas_categoria</span><span class="p">[</span><span class="s1">&#39;NIT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>  <span class="c1"># Asumo que &#39;NIT&#39; es el identificador de la empresa</span>
    <span class="n">empresas_aleatorias</span><span class="p">[</span><span class="n">categoria</span><span class="p">]</span> <span class="o">=</span> <span class="n">empresa_aleatoria</span>
</pre></div>
</div>
</div>
</div>
<p>Las variable spara cada categoría que tienden a reprtirse entre la smismas son similares a las variables generales.</p>
<ul class="simple">
<li><p>Generación de efectivo y ROA son de tendencia creciente constante y se ctalogan como las más importantes en todos lso grupos dado su tendencia alza y alta densidad de aporte en todas las categorías.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">categoria</span><span class="p">,</span> <span class="n">empresa</span> <span class="ow">in</span> <span class="n">empresas_aleatorias</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">empresa_data</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;NIT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">empresa</span><span class="p">]</span>
    <span class="n">empresa_year</span> <span class="o">=</span> <span class="n">empresa_data</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">empresa_year</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">empresa_year</span><span class="p">][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>


    <span class="c1"># Ajustar el modelo con los mejores hiperparámetros de XGBoost</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>

    <span class="c1"># Extract variable importances from the fitted model</span>
    <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;xgbclassifier&#39;</span><span class="p">]</span>
    <span class="n">feature_importance</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">feature_importances_</span>


    <span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Variable&#39;</span><span class="p">:</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="s1">&#39;Importancia&#39;</span><span class="p">:</span> <span class="n">feature_importance</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
    <span class="p">})</span>

    <span class="c1"># Graficar la importancia de las variables (Feature Importance)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">importance</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Importancia&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Importancia de las Variables para la Empresa </span><span class="si">{</span><span class="n">empresa</span><span class="si">}</span><span class="s2"> (Categoría: </span><span class="si">{</span><span class="n">categoria</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Graficar la tendencia de la importancia de las variables por año</span>
    <span class="n">importance_trend_df</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Año&#39;</span><span class="p">,</span> <span class="s1">&#39;Variable&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;Importancia&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Filtrar solo las importancias para esa empresa</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Graficar múltiples líneas para cada variable</span>
    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">importance_trend_df</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">variable_data</span> <span class="o">=</span> <span class="n">importance_trend_df</span><span class="p">[</span><span class="n">importance_trend_df</span><span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">variable</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">variable_data</span><span class="p">[</span><span class="s1">&#39;Año&#39;</span><span class="p">],</span> <span class="n">variable_data</span><span class="p">[</span><span class="s1">&#39;Importancia&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">variable</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tendencia de la Importancia de las Variables para la Empresa </span><span class="si">{</span><span class="n">empresa</span><span class="si">}</span><span class="s2"> (Categoría: </span><span class="si">{</span><span class="n">categoria</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Importancia Promedio&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Variables&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-178-64e73a87833f&gt;:34: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.
</pre></div>
</div>
<img alt="_images/03a3259f08c99d8bd1749644ae7dc9cd3af17aeee033cb1f28730166a1db77cf.png" src="_images/03a3259f08c99d8bd1749644ae7dc9cd3af17aeee033cb1f28730166a1db77cf.png" />
<img alt="_images/94734047ef808dbc4745d838eee8a9238b64dceb9846bdbfeef78a5cd3b766e7.png" src="_images/94734047ef808dbc4745d838eee8a9238b64dceb9846bdbfeef78a5cd3b766e7.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-178-64e73a87833f&gt;:34: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.
</pre></div>
</div>
<img alt="_images/12f6bad1bcee35532b0ee0c2a4aa62199273ba51e98721de3c5b021ea009b976.png" src="_images/12f6bad1bcee35532b0ee0c2a4aa62199273ba51e98721de3c5b021ea009b976.png" />
<img alt="_images/f924e6cefe6f29ba2715c49efc5988c6d3ae2124b1b433738fd2681614c89528.png" src="_images/f924e6cefe6f29ba2715c49efc5988c6d3ae2124b1b433738fd2681614c89528.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-178-64e73a87833f&gt;:34: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.
</pre></div>
</div>
<img alt="_images/97c6d01f033cb009070cbdc0ec726b7e7805c7ba00fe895c938a695f6538700a.png" src="_images/97c6d01f033cb009070cbdc0ec726b7e7805c7ba00fe895c938a695f6538700a.png" />
<img alt="_images/8d74a8cdc4cf7789fb56d97d9a7b3abe23e9848a6f4b25acb67cfddab4202557.png" src="_images/8d74a8cdc4cf7789fb56d97d9a7b3abe23e9848a6f4b25acb67cfddab4202557.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-178-64e73a87833f&gt;:34: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.
</pre></div>
</div>
<img alt="_images/dc8784def9de427eed6c9f905477e58e715b0667a688e521889fe9b9c0b2d72e.png" src="_images/dc8784def9de427eed6c9f905477e58e715b0667a688e521889fe9b9c0b2d72e.png" />
<img alt="_images/24b690b0cfb4c6a64de2072310ef69b4cb0b9b59add6a2d3cb8a8ce5f23dc798.png" src="_images/24b690b0cfb4c6a64de2072310ef69b4cb0b9b59add6a2d3cb8a8ce5f23dc798.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-178-64e73a87833f&gt;:34: FutureWarning:



Passing `palette` without assigning `hue` is deprecated and will be removed in v0.14.0. Assign the `y` variable to `hue` and set `legend=False` for the same effect.
</pre></div>
</div>
<img alt="_images/854489d8b6ef82ef1d7ae80573ca1ac252572d675b4a52417b8622627d4f4ee9.png" src="_images/854489d8b6ef82ef1d7ae80573ca1ac252572d675b4a52417b8622627d4f4ee9.png" />
<img alt="_images/8b110ecc83aa231aba934e0c044405ecf1e0a4781a5ed771ab46ff8486151d54.png" src="_images/8b110ecc83aa231aba934e0c044405ecf1e0a4781a5ed771ab46ff8486151d54.png" />
</div>
</div>
</section>
<section id="supuestos-del-modelo">
<h3>Supuestos del modelo<a class="headerlink" href="#supuestos-del-modelo" title="Link to this heading">#</a></h3>
<p>Inicialmente se obtienen las probabilidades de clasificación de las clases mal clasificadas y a esto se le denomina residuos del modleo, ya que no es un problema de regresión.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Realizamos predicciones utilizando el modelo LightGBM</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>  <span class="c1"># Probabilidades para todas las clases</span>

<span class="c1"># Obtener las clases predichas (la clase con mayor probabilidad)</span>
<span class="n">y_pred_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Residuos en clasificación: calculamos la diferencia entre la probabilidad de la clase correcta y 1</span>
<span class="n">residuals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">)):</span>
    <span class="c1"># Access element using integer indexing for NumPy arrays</span>
    <span class="n">true_class</span> <span class="o">=</span> <span class="n">y_test_encoded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">predicted_prob</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">true_class</span><span class="p">]</span>
    <span class="n">residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">predicted_prob</span><span class="p">)</span>  <span class="c1"># Residuo como diferencia entre 1 y la probabilidad de la clase correcta</span>

<span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="independencia-de-las-observaciones">
<h4>Independencia de las observaciones<a class="headerlink" href="#independencia-de-las-observaciones" title="Link to this heading">#</a></h4>
<p>Se realiza un gráfico de autocorrelación para verificar que no existe dependencia entre las observaciones de un grupo determinado en el pliege de validación (2017-2018, 2017+2018-2019, 2017+2018+2019-2020,…, 2023).</p>
<p>Se concluye que no existe correlación entre las mismas dado el estadístico de prueba durbin-watson cercano a 3 (1.9574).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Verificación de autocorrelación con Durbin-Watson</span>
<span class="n">dw_stat</span> <span class="o">=</span> <span class="n">durbin_watson</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estadístico de Durbin-Watson: </span><span class="si">{</span><span class="n">dw_stat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Interpretación:</span>
<span class="c1"># Un valor cercano a 2 sugiere que no hay autocorrelación.</span>
<span class="c1"># Un valor cercano a 0 o 4 sugiere autocorrelación positiva o negativa respectivamente.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estadístico de Durbin-Watson: 1.9574365674207523
</pre></div>
</div>
</div>
</div>
<p><strong>Gráfica autocorrelación</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Autocorrelación de los Residuos&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 1200x600 with 0 Axes&gt;
</pre></div>
</div>
<img alt="_images/40b5f97cb7af7255e29341ddf30608795df60647476e088f32ecd370347d6140.png" src="_images/40b5f97cb7af7255e29341ddf30608795df60647476e088f32ecd370347d6140.png" />
</div>
</div>
</section>
<section id="estacionariedad-de-las-series-temporales">
<h4><strong>Estacionariedad de las series temporales</strong><a class="headerlink" href="#estacionariedad-de-las-series-temporales" title="Link to this heading">#</a></h4>
<p>Se verifica que los datos, al haber sido separados por pliegues de validación secuencial anual cumplen con el supuesto de estacionariedad. En este caso las probabilidades de la clasificación cumplen con el supuesto de estacionariedad temporal en el plazo de la serie temporal (2017 - 2023) para cada variable de la muestra.</p>
<ul>
<li><p><strong>Cantidad de años de la empresa</strong>:</p>
<ul class="simple">
<li><p>Estadístico ADF: -2.37</p></li>
<li><p>Valor p: 0.149</p></li>
<li><p><strong>Conclusión</strong>: La serie <strong>NO es estacionaria</strong>.</p></li>
</ul>
</li>
<li><p><strong>Razón corriente</strong>:</p>
<ul class="simple">
<li><p>Estadístico ADF: -76.36</p></li>
<li><p>Valor p: 0.00</p></li>
<li><p><strong>Conclusión</strong>: La serie <strong>es estacionaria</strong>.</p></li>
</ul>
</li>
<li><p><strong>Rotación cartera</strong>:</p>
<ul class="simple">
<li><p>Estadístico ADF: -32.75</p></li>
<li><p>Valor p: 0.00</p></li>
<li><p><strong>Conclusión</strong>: La serie <strong>es estacionaria</strong>.</p></li>
</ul>
</li>
<li><p><strong>ROA</strong>:</p>
<ul class="simple">
<li><p>Estadístico ADF: -75.99</p></li>
<li><p>Valor p: 0.00</p></li>
<li><p><strong>Conclusión</strong>: La serie <strong>es estacionaria</strong>.</p></li>
</ul>
</li>
<li><p><strong>ROE</strong>:</p>
<ul class="simple">
<li><p>Estadístico ADF: -76.27</p></li>
<li><p>Valor p: 0.00</p></li>
<li><p><strong>Conclusión</strong>: La serie <strong>es estacionaria</strong>.</p></li>
</ul>
</li>
<li><p><strong>Generación Efectivo</strong>:</p>
<ul class="simple">
<li><p>Estadístico ADF: -76.26</p></li>
<li><p>Valor p: 0.00</p></li>
<li><p><strong>Conclusión</strong>: La serie <strong>es estacionaria</strong>.</p></li>
</ul>
</li>
<li><p><strong>Estado actual</strong>:</p>
<ul class="simple">
<li><p>La columna no es numérica, se omite el test ADF.</p></li>
</ul>
</li>
<li><p><strong>Concepto del Revisor fiscal en su orme</strong>:</p>
<ul class="simple">
<li><p>La columna no es numérica, se omite el test ADF.</p></li>
</ul>
</li>
<li><p><strong>La compañía está obligada a tener Revisor fiscal?</strong>:</p>
<ul class="simple">
<li><p>La columna no es numérica, se omite el test ADF.</p></li>
</ul>
</li>
<li><p><strong>Tipo societario</strong>:</p>
<ul class="simple">
<li><p>La columna no es numérica, se omite el test ADF.</p></li>
</ul>
</li>
<li><p><strong>Departamento de la dirección del domicilio</strong>:</p>
<ul class="simple">
<li><p>La columna no es numérica, se omite el test ADF.</p></li>
</ul>
</li>
<li><p><strong>Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)</strong>:</p>
<ul class="simple">
<li><p>La columna no es numérica, se omite el test ADF.</p></li>
</ul>
<p>Se concluye que la muestra y el modelo si cumplen con el supuesto de estacionariedad en los pliegues de validación implementados.</p>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Realizar el test ADF para verificar la estacionariedad</span>
<span class="k">def</span> <span class="nf">test_stationarity</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># Check if the data is numeric</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="n">adf_result</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estadístico ADF: </span><span class="si">{</span><span class="n">adf_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valor p: </span><span class="si">{</span><span class="n">adf_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adf_result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;La serie es estacionaria&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;La serie NO es estacionaria&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;La columna no es numérica, se omite el test ADF.&quot;</span><span class="p">)</span>

<span class="c1"># Test de estacionariedad para cada variable</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test de estacionariedad para </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="n">test_stationarity</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test de estacionariedad para Cantidad de años de la empresa:
Estadístico ADF: -2.3745309725169457
Valor p: 0.14905424766713893
La serie NO es estacionaria

Test de estacionariedad para Razón corriente:
Estadístico ADF: -76.35597974491998
Valor p: 0.0
La serie es estacionaria

Test de estacionariedad para Rotación cartera:
Estadístico ADF: -32.748816390000094
Valor p: 0.0
La serie es estacionaria

Test de estacionariedad para ROA:
Estadístico ADF: -75.98509967178781
Valor p: 0.0
La serie es estacionaria

Test de estacionariedad para ROE:
Estadístico ADF: -76.27014026793795
Valor p: 0.0
La serie es estacionaria

Test de estacionariedad para Generación Efectivo:
Estadístico ADF: -76.26289139137445
Valor p: 0.0
La serie es estacionaria

Test de estacionariedad para Estado actual:
La columna no es numérica, se omite el test ADF.

Test de estacionariedad para Concepto del Revisor fiscal en su orme:
La columna no es numérica, se omite el test ADF.

Test de estacionariedad para La compañía está obligada a tener Revisor fiscal?:
La columna no es numérica, se omite el test ADF.

Test de estacionariedad para Tipo societario:
La columna no es numérica, se omite el test ADF.

Test de estacionariedad para Departamento de la dirección del domicilio:
La columna no es numérica, se omite el test ADF.

Test de estacionariedad para Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU):
La columna no es numérica, se omite el test ADF.
</pre></div>
</div>
</div>
</div>
</section>
<section id="verificar-poca-o-nula-multicolinealidad">
<h4>Verificar poca o nula multicolinealidad<a class="headerlink" href="#verificar-poca-o-nula-multicolinealidad" title="Link to this heading">#</a></h4>
<p>Se verifica mediante el calculo del factor de inflación de la varianza si existe alguna correlación entre las variables numéricas del conjunto de datos. Si el VIF &gt; 10 se considera existencia de multicolinealidad.</p>
<p>Dado que no existe correlación numerica significativa ni directa ni inversa y que el VIF &lt; 10 para todas las variables numéricas implementadas en el modelo se concluye que no hay multicolinealidad, por tanto se cumple el supuesto.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calcular VIF para las variables en X_train</span>
<span class="n">X_train_vif</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>  <span class="c1"># Agregar constante para el cálculo de VIF</span>

<span class="c1"># Convertir todas las columnas a numéricas si es posible, o manejar las no numéricas</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_train_vif</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">X_train_vif</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Intentar convertir la columna a numérica</span>
            <span class="n">X_train_vif</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">X_train_vif</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Manejar columnas que no se pueden convertir, por ejemplo, eliminándolas o usando codificación one-hot</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columna &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; no es numérica y no se puede convertir. Se eliminará para el cálculo del VIF.&quot;</span><span class="p">)</span>
            <span class="n">X_train_vif</span> <span class="o">=</span> <span class="n">X_train_vif</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="c1"># Si la columna es categórica, podrías usar pd.get_dummies() para codificación one-hot</span>

<span class="n">vif_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train_vif</span><span class="o">.</span><span class="n">columns</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;VIF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X_train_vif</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_train_vif</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

<span class="c1"># Mostrar VIF</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vif_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Columna &#39;Estado actual&#39; no es numérica y no se puede convertir. Se eliminará para el cálculo del VIF.
Columna &#39;Concepto del Revisor fiscal en su orme&#39; no es numérica y no se puede convertir. Se eliminará para el cálculo del VIF.
Columna &#39;La compañía está obligada a tener Revisor fiscal?&#39; no es numérica y no se puede convertir. Se eliminará para el cálculo del VIF.
Columna &#39;Tipo societario&#39; no es numérica y no se puede convertir. Se eliminará para el cálculo del VIF.
Columna &#39;Departamento de la dirección del domicilio&#39; no es numérica y no se puede convertir. Se eliminará para el cálculo del VIF.
Columna &#39;Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)&#39; no es numérica y no se puede convertir. Se eliminará para el cálculo del VIF.
                         Variable       VIF
0                           const  3.821990
1  Cantidad de años de la empresa  1.002266
2                 Razón corriente  1.010389
3                Rotación cartera  1.015201
4                             ROA  1.001425
5                             ROE  1.001268
6             Generación Efectivo  1.004621
</pre></div>
</div>
</div>
</div>
</section>
<section id="homocedasticidad-de-las-probabilidades-extraidas-de-los-residuos">
<h4>Homocedasticidad de las probabilidades extraídas de los residuos<a class="headerlink" href="#homocedasticidad-de-las-probabilidades-extraidas-de-los-residuos" title="Link to this heading">#</a></h4>
<p>Se verifica que la distribución o el comportamiento de las probabilidaes de los residuos de clasificación tienen una varianza homogenea o constante. Se selecciona incialmente las variables numéricas dle conjunto de datos .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Paso 1: Filtrar las columnas numéricas (excluir las categóricas)</span>
<span class="n">X_train_numeric</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>

<span class="c1"># Verificar que X_train_numeric ahora solo contiene variables numéricas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train_numeric</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        Cantidad de años de la empresa  Razón corriente  Rotación cartera  \
118882                            36.0         1.212657         29.189779   
118883                            36.0         5.290916         74.292334   
118884                            36.0         3.300313         37.662737   
118885                            36.0         2.139800        170.064847   
118892                            36.0         1.801147         46.734369   

             ROA       ROE  Generación Efectivo  
118882  0.050954  0.137577             0.136177  
118883  0.003609  0.005455            -0.550855  
118884  0.110797  0.202389            -0.925603  
118885  0.187122  0.340824            -0.108914  
118892  0.010222  0.020959             5.897421  
</pre></div>
</div>
</div>
</div>
<p>Haciendo uso del estadístico del test de breush-pagan se concluye que dado <code class="docutils literal notranslate"><span class="pre">p-valor</span> <span class="pre">(0.6817)</span></code> mayor a cualquier nivel de significancia (<code class="docutils literal notranslate"><span class="pre">alfa</span></code>) las probabilidades tienen una varianza homocedastica, pr lo tanto cumple con el supuesto.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import statsmodels.formula.api as smf</span>
<span class="c1"># import statsmodels.stats.api as sms</span>

<span class="c1"># Realizar el test de heterocedasticidad de Breusch-Pagan con las variables numéricas</span>
<span class="n">X_train_numeric</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_train_numeric</span><span class="p">)</span>
<span class="n">bp_test</span> <span class="o">=</span> <span class="n">sms</span><span class="o">.</span><span class="n">het_breuschpagan</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">X_train_numeric</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estadístico de Breusch-Pagan: </span><span class="si">{</span><span class="n">bp_test</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valor p: </span><span class="si">{</span><span class="n">bp_test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Interpretación:</span>
<span class="k">if</span> <span class="n">bp_test</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hay heterocedasticidad&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay heterocedasticidad&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Estadístico de Breusch-Pagan: 3.962650850700574
Valor p: 0.6817309262996887
No hay heterocedasticidad
</pre></div>
</div>
</div>
</div>
</section>
<section id="verificacion-de-la-no-colinealidad-temporal">
<h4>Verificación de la no colinealidad temporal<a class="headerlink" href="#verificacion-de-la-no-colinealidad-temporal" title="Link to this heading">#</a></h4>
<p>Se verificará que no exista una correlación entre el tiempo y la significancia de las variables, dado que es panel data, se puede filtrar información que dependa del tiempo para cualquwira de la svariables. Para observar si el modleo no viola esta independencia temporal, se agregan variables de lagg para observar su iteracción o correlación con las variables a nivel general.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Incluir variables rezagadas (lagged features)</span>
<span class="n">X_train_lagged</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">X_train_lagged</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_lagged&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Crear lag de 1 año</span>
</pre></div>
</div>
</div>
</div>
<p>Se consluye que el modelo no presenta correlación temporal entre sus variables, por lo que cumple con el supuesto de no colinealidad temporal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Excluir las columnas categóricas (solo seleccionar columnas numéricas)</span>
<span class="n">X_train_lagged_numeric</span> <span class="o">=</span> <span class="n">X_train_lagged</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train_lagged_numeric</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">X_train_lagged_numeric</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Matriz de Correlación con Variables Rezagadas&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        Cantidad de años de la empresa  Razón corriente  Rotación cartera  \
118882                            36.0         1.212657         29.189779   
118883                            36.0         5.290916         74.292334   
118884                            36.0         3.300313         37.662737   
118885                            36.0         2.139800        170.064847   
118892                            36.0         1.801147         46.734369   

             ROA       ROE  Generación Efectivo  \
118882  0.050954  0.137577             0.136177   
118883  0.003609  0.005455            -0.550855   
118884  0.110797  0.202389            -0.925603   
118885  0.187122  0.340824            -0.108914   
118892  0.010222  0.020959             5.897421   

        Cantidad de años de la empresa_lagged  Razón corriente_lagged  \
118882                                    NaN                     NaN   
118883                                   36.0                1.212657   
118884                                   36.0                5.290916   
118885                                   36.0                3.300313   
118892                                   36.0                2.139800   

        Rotación cartera_lagged  ROA_lagged  ROE_lagged  \
118882                      NaN         NaN         NaN   
118883                29.189779    0.050954    0.137577   
118884                74.292334    0.003609    0.005455   
118885                37.662737    0.110797    0.202389   
118892               170.064847    0.187122    0.340824   

        Generación Efectivo_lagged  
118882                         NaN  
118883                    0.136177  
118884                   -0.550855  
118885                   -0.925603  
118892                   -0.108914  
</pre></div>
</div>
<img alt="_images/dda55629aa994e2b0809ad0b27c411818cea861f23f15a31e9062948ab89ce58.png" src="_images/dda55629aa994e2b0809ad0b27c411818cea861f23f15a31e9062948ab89ce58.png" />
</div>
</div>
</section>
</section>
<section id="conslusion-del-modelo-base-xgboost">
<h3>Conslusión del modelo base XGBoost<a class="headerlink" href="#conslusion-del-modelo-base-xgboost" title="Link to this heading">#</a></h3>
<p>El modelo <code class="docutils literal notranslate"><span class="pre">Extreme</span> <span class="pre">Gradient</span> <span class="pre">Boosting</span> <span class="pre">(XGBoost)</span></code> que fue utilizado como base dada sus métricas durante el benchmark de modelos, cumple con los supuestos lo cual le da validez estadística para realizar clasificaciones. Se propone mejorar su puntaje de AUC-ROC en la clasificación y además se evidencian métricas de clasificación poco competitivas disponibles a optimizar o mejorar por lo que se propone realizar un stack con el modelo <code class="docutils literal notranslate"><span class="pre">Light</span> <span class="pre">Gradient</span> <span class="pre">Boosting</span> <span class="pre">Machine</span> <span class="pre">(LigthGBM</span></code>).  El objetivo del uso de los dos modelos en metodología de stack es poder aumentar el rendimeinto de clasificación mediante la curva AUC-ROC y de las métricas de clasificación, accuracy, precision, Recall, F1-score de forma paralela.</p>
<p>A continuación se procede a utilizar las probabilidades de las predicciones residuales (aquellas etiquetas de clasificción que fueron mal determinadas) como input para la predicción en el modelo LightGBM, es decir, reforzar las clasificaciones de los errores.</p>
</section>
</section>
<section id="modelo-de-stacking-con-ligthgbm">
<h2>Modelo de stacking con LIgthGBM<a class="headerlink" href="#modelo-de-stacking-con-ligthgbm" title="Link to this heading">#</a></h2>
<p>Se hará uso de la probabilidad de los residuso para clasificar nuevamente los datos del modelo y mejorar en los puntos donde el modelo está fallando. Inicialmente se hace una copia del nuevo conjunto de datos con el que se trabajará y que no haya errores de manejo de datos. Luego, se crea una columna nueva en el conjunto de datos que representa la probabilidad de elección de una clase.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Realizamos predicciones utilizando el modelo LightGBM</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>  <span class="c1"># Probabilidades para todas las clases</span>

<span class="c1"># Obtener las clases predichas (la clase con mayor probabilidad)</span>
<span class="n">y_pred_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Residuos en clasificación: calculamos la diferencia entre la probabilidad de la clase correcta y 1</span>
<span class="n">residuals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">)):</span>
    <span class="c1"># Access element using integer indexing for NumPy arrays</span>
    <span class="n">true_class</span> <span class="o">=</span> <span class="n">y_test_encoded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">predicted_prob</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">true_class</span><span class="p">]</span>
    <span class="n">residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">predicted_prob</span><span class="p">)</span>  <span class="c1"># Residuo como diferencia entre 1 y la probabilidad de la clase correcta</span>

<span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Añadir los residuos como una nueva columna en el conjunto de entrenamiento</span>
<span class="n">X_train_stacked</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_train_stacked</span><span class="p">[</span><span class="s1">&#39;Residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">residuals</span>

<span class="c1"># Si ya tienes datos de prueba (X_test), también agrega los residuos de las predicciones</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">residuals_test</span> <span class="o">=</span> <span class="n">y_test_encoded</span> <span class="o">-</span> <span class="n">y_test_pred</span>
<span class="n">X_test_stacked</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test_stacked</span><span class="p">[</span><span class="s1">&#39;Residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">residuals_test</span>

<span class="c1"># Dividir los datos por año para entrenamiento secuencial</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Funciones para el control de la busqueda de los mejores parámetros.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Función para el objetivo de Optuna</span>
<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;multiclass&#39;</span><span class="p">,</span>
        <span class="s1">&#39;num_class&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train_encoded</span><span class="p">)),</span>
        <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;multi_logloss&#39;</span><span class="p">,</span>
        <span class="s1">&#39;boosting_type&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s1">&#39;boosting_type&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;gbdt&#39;</span><span class="p">,</span> <span class="s1">&#39;dart&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s1">&#39;num_leaves&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
        <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_loguniform</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
        <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_uniform</span><span class="p">(</span><span class="s1">&#39;feature_fraction&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Entrenamiento de LightGBM en los residuos</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>  <span class="c1"># Entrenar sobre los residuos</span>

    <span class="c1"># Evaluación con los datos de validación</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>  <span class="c1"># Usamos la precisión como métrica</span>
    <span class="k">return</span> <span class="n">accuracy</span>  <span class="c1"># Maximizar la precisión</span>

<span class="c1"># Entrenamiento secuencial por año</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<section id="gridsearch-de-mejores-hiperparametros">
<h3>Gridsearch de mejores hiperparámetros<a class="headerlink" href="#gridsearch-de-mejores-hiperparametros" title="Link to this heading">#</a></h3>
<p>Se realiza una busqueda en red para encontrar los mejores parámetros del modelo Ligth Gradient Boosting Machine (LigthGBM).</p>
<p><strong>Parámetros</strong></p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">objective</span></code></strong>: Define el tipo de tarea del modelo, en este caso, clasificación multiclase.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">num_class</span></code></strong>: Número de clases en el conjunto de datos de entrenamiento.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">metric</span></code></strong>: Métrica usada para evaluar el modelo; aquí se utiliza el logaritmo de pérdida multiclasificación.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">boosting_type</span></code></strong>: Tipo de boosting utilizado, puede ser ‘gbdt’ (gradiente boosting) o ‘dart’ (Dropouts meet Multiple Additive Regression Trees).</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">num_leaves</span></code></strong>: Número máximo de hojas por árbol, controla la complejidad del modelo.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">learning_rate</span></code></strong>: Tasa de aprendizaje, regula la velocidad con la que el modelo se ajusta.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">feature_fraction</span></code></strong>: Fracción de características a usar en cada iteración, ayuda a evitar el sobreajuste.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iteración secuencial por año</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)):</span>
    <span class="n">train_years</span> <span class="o">=</span> <span class="n">years</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># Datos de entrenamiento hasta el año i-1</span>
    <span class="n">test_year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="c1"># Año para la prueba</span>

    <span class="c1"># Filtrar los datos de entrenamiento y prueba</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

    <span class="c1"># Codificar las etiquetas de la variable objetivo para entrenamiento</span>
    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_test_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>

    <span class="c1"># Obtener los residuos del modelo XGBoost (puedes usar el modelo entrenado de XGBoost)</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">get_residuals</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>

    <span class="c1"># División de los residuos para entrenamiento y validación</span>
    <span class="n">X_train_lgbm</span><span class="p">,</span> <span class="n">X_val_lgbm</span><span class="p">,</span> <span class="n">y_train_lgbm</span><span class="p">,</span> <span class="n">y_val_lgbm</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Búsqueda de los mejores parámetros con Optuna</span>
    <span class="n">study</span> <span class="o">=</span> <span class="n">optuna</span><span class="o">.</span><span class="n">create_study</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;maximize&#39;</span><span class="p">)</span>
    <span class="n">study</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">trial</span><span class="p">:</span> <span class="n">objective</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">X_train_lgbm</span><span class="p">,</span> <span class="n">y_train_lgbm</span><span class="p">,</span> <span class="n">X_val_lgbm</span><span class="p">,</span> <span class="n">y_val_lgbm</span><span class="p">),</span> <span class="n">n_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Imprimir los mejores parámetros encontrados</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best parameters for year </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">study</span><span class="o">.</span><span class="n">best_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Obtener el mejor modelo con los parámetros optimizados</span>
    <span class="n">best_params</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">best_params</span>
    <span class="n">lgb_model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">best_params</span><span class="p">)</span>
    <span class="n">lgb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_lgbm</span><span class="p">,</span> <span class="n">y_train_lgbm</span><span class="p">)</span>

    <span class="c1"># Evaluar el modelo de LightGBM en el conjunto de prueba</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">lgb_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Obtener probabilidades predichas (y_pred_proba)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">lgb_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Verifica que las probabilidades sumen 1 para cada fila</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Las probabilidades no suman 1&quot;</span>

    <span class="c1"># Asegurar que las probabilidades estén alineadas con las clases de y_test_encoded</span>
    <span class="n">classes_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">)</span>
    <span class="n">y_pred_proba_adjusted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes_order</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lgb_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes_order</span><span class="p">:</span>
            <span class="n">target_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">classes_order</span> <span class="o">==</span> <span class="bp">cls</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y_pred_proba_adjusted</span><span class="p">[:,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

    <span class="c1"># Reemplazar y_pred_proba con las probabilidades ajustadas</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">y_pred_proba_adjusted</span>

    <span class="c1"># Calcular ROC AUC con las probabilidades ajustadas</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en ROC AUC para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="c1"># Calcular métricas adicionales</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">class_report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="c1"># Agregar las métricas a los resultados</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_year</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Classification Report&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_report</span><span class="p">)</span>

<span class="c1"># Imprimir resultados finales</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Mejores parametros</strong></p>
<p>Se concluye que los mejores parámetros son:</p>
<ul class="simple">
<li><p><strong>objective</strong>: ‘multiclass’</p></li>
<li><p><strong>num_class</strong>: 5</p></li>
<li><p><strong>metric</strong>: ‘multi_logloss’</p></li>
<li><p><strong>boosting_type</strong>: ‘dart’</p></li>
<li><p><strong>num_leaves</strong>: 44</p></li>
<li><p><strong>learning_rate</strong>: 0.03590658068854122</p></li>
<li><p><strong>feature_fraction</strong>: 0.9751143272589864</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Definir los parámetros fijos seleccionados del grupo de parámetros proporcionado</span>
<span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;multiclass&#39;</span><span class="p">,</span>
    <span class="s1">&#39;num_class&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train_encoded</span><span class="p">)),</span>  <span class="c1"># 5</span>
    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;multi_logloss&#39;</span><span class="p">,</span>
    <span class="s1">&#39;boosting_type&#39;</span><span class="p">:</span> <span class="s1">&#39;dart&#39;</span><span class="p">,</span>  <span class="c1"># Se selecciona &#39;dart&#39; basado en la optimización previa</span>
    <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span>  <span class="c1"># Basado en la búsqueda anterior (si es el mejor valor encontrado)</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.03590658068854122</span><span class="p">,</span>  <span class="c1"># Mejor learning_rate obtenido</span>
    <span class="s1">&#39;feature_fraction&#39;</span><span class="p">:</span> <span class="mf">0.9751143272589864</span>  <span class="c1"># Mejor feature_fraction obtenido</span>
<span class="p">}</span>

<span class="c1"># Codificador de etiquetas</span>
<span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Se verifica el tipo de variables en el conjunto de datos para propósitos de estandarización y codificación adecuado en el pipeline del modelo y así evitar fuga de datos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Verifica el tipo de datos en X_train</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cantidad de años de la empresa                                           float64
Razón corriente                                                          float64
Rotación cartera                                                         float64
ROA                                                                      float64
ROE                                                                      float64
Generación Efectivo                                                      float64
Estado actual                                                           category
Concepto del Revisor fiscal en su orme                                  category
La compañía está obligada a tener Revisor fiscal?                       category
Tipo societario                                                         category
Departamento de la dirección del domicilio                              category
Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)    category
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Identificar las columnas numéricas y categóricas</span>
<span class="n">categorical_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
<span class="n">numerical_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>

<span class="c1"># Preprocesamiento de datos</span>
<span class="c1"># Usamos SimpleImputer para manejar datos faltantes y OneHotEncoder para convertir las variables categóricas</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">numerical_cols</span><span class="p">),</span>  <span class="c1"># Escalar las columnas numéricas</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>  <span class="c1"># Imputar valores faltantes con el valor más frecuente</span>
            <span class="p">(</span><span class="s1">&#39;onehot&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">))</span>  <span class="c1"># Codificación OneHot para las categóricas</span>
        <span class="p">]),</span> <span class="n">categorical_cols</span><span class="p">)</span>
    <span class="p">])</span>

<span class="c1"># Crear el pipeline para entrenamiento</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  <span class="c1"># Aplicar el preprocesamiento</span>
    <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">))</span>  <span class="c1"># Clasificador LightGBM</span>
<span class="p">])</span>

<span class="c1"># Iteración secuencial por año, entrenando con años anteriores y evaluando con el siguiente año</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Verificar las columnas categóricas</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Columnas categóricas:&quot;</span><span class="p">,</span> <span class="n">categorical_cols</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Columnas numéricas:&quot;</span><span class="p">,</span> <span class="n">numerical_cols</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Columnas categóricas: Index([], dtype=&#39;object&#39;)
Columnas numéricas: Index([&#39;Cantidad de años de la empresa&#39;, &#39;Razón corriente&#39;, &#39;Rotación cartera&#39;,
       &#39;ROA&#39;, &#39;ROE&#39;, &#39;Generación Efectivo&#39;, &#39;Estado actual&#39;,
       &#39;Concepto del Revisor fiscal en su orme&#39;,
       &#39;La compañía está obligada a tener Revisor fiscal?&#39;, &#39;Tipo societario&#39;,
       &#39;Departamento de la dirección del domicilio&#39;,
       &#39;Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="entrenmiento-del-modelo-matriz-de-confusion-y-metricas-del-modelo">
<h3>Entrenmiento del modelo, matriz de confusión y métricas del modelo.<a class="headerlink" href="#entrenmiento-del-modelo-matriz-de-confusion-y-metricas-del-modelo" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">2018</span></code></p>
<ul class="simple">
<li><p>Exactitud: 0.40</p></li>
<li><p>ROC AUC: 0.66</p></li>
<li><p>F1 Score: 0.39</p></li>
<li><p>Precisión: 0.39</p></li>
<li><p>Recall: 0.40</p></li>
<li><p>Observaciones: Baja exactitud y F1 score, con un desempeño moderado en precisión y recall.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">2019</span></code></p>
<ul class="simple">
<li><p>Exactitud: 0.44</p></li>
<li><p>ROC AUC: 0.71</p></li>
<li><p>F1 Score: 0.42</p></li>
<li><p>Precisión: 0.44</p></li>
<li><p>Recall: 0.44</p></li>
<li><p>Observaciones: Mejora moderada en comparación con 2018, especialmente en AUC.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">2020</span></code></p>
<ul class="simple">
<li><p>Exactitud: 0.44</p></li>
<li><p>ROC AUC: 0.71</p></li>
<li><p>F1 Score: 0.42</p></li>
<li><p>Precisión: 0.42</p></li>
<li><p>Recall: 0.44</p></li>
<li><p>Observaciones: Desempeño similar a 2019, con un ajuste marginal en precisión.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">2021</span></code></p>
<ul class="simple">
<li><p>Exactitud: 0.45</p></li>
<li><p>ROC AUC: 0.73</p></li>
<li><p>F1 Score: 0.43</p></li>
<li><p>Precisión: 0.42</p></li>
<li><p>Recall: 0.45</p></li>
<li><p>Observaciones: Ligera mejora en comparación con 2020, con un aumento en AUC.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">2022</span></code></p>
<ul class="simple">
<li><p>Exactitud: 0.45</p></li>
<li><p>ROC AUC: 0.72</p></li>
<li><p>F1 Score: 0.43</p></li>
<li><p>Precisión: 0.43</p></li>
<li><p>Recall: 0.45</p></li>
<li><p>Observaciones: Similar desempeño al de 2021, con ligeras mejoras en recall y
precisión.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">2023</span></code></p>
<ul class="simple">
<li><p>Exactitud: 0.46</p></li>
<li><p>ROC AUC: 0.74</p></li>
<li><p>F1 Score: 0.44</p></li>
<li><p>Precisión: 0.44</p></li>
<li><p>Recall: 0.46</p></li>
<li><p>Observaciones: Mejora continua, especialmente en AUC y exactitud.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lista para almacenar los resultados</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;ROC AUC&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;F1 Score&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s1">&#39;Classification Report&#39;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)):</span>  <span class="c1"># Comenzamos desde el segundo año</span>
    <span class="c1"># Usamos los años anteriores para entrenamiento y el año actual para prueba</span>
    <span class="n">train_years</span> <span class="o">=</span> <span class="n">years</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># Datos de entrenamiento hasta el año i-1</span>
    <span class="n">test_year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="c1"># Año para la prueba</span>

    <span class="c1"># Filtrar los datos de entrenamiento y prueba</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">])</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

    <span class="c1"># Codificar las etiquetas de la variable objetivo para entrenamiento</span>
    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_test_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>

    <span class="c1"># Entrenar el modelo con el pipeline</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  <span class="c1"># Aplicar el preprocesamiento</span>
        <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">))</span>  <span class="c1"># Clasificador LightGBM</span>
    <span class="p">])</span>

    <span class="c1"># Entrenamiento</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>

    <span class="c1"># Evaluación</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>  <span class="c1"># Probabilidades predichas</span>

    <span class="c1"># Asegurar que las probabilidades sumen 1 para cada fila (esto es necesario para ROC AUC)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Las probabilidades no suman 1&quot;</span>

    <span class="c1"># Calcular ROC AUC con las probabilidades ajustadas</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error en ROC AUC para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Si ocurre un error, lo manejamos adecuadamente.</span>

    <span class="c1"># Calcular otras métricas de evaluación</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">class_report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="c1"># Graficar la matriz de confusión</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">xticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matriz de Confusión para </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicción&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Real&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Graficar la curva ROC para cada clase (si es clasificación multiclase)</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Para la clase positiva</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AUC - </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC AUC para </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Agregar las métricas a los resultados</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_year</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Classification Report&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_report</span><span class="p">)</span>

<span class="c1"># Imprimir los resultados finales</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Info] Auto-choosing row-wise multi-threading, the overhead of testing was 0.000709 seconds.
You can set `force_row_wise=true` to remove the overhead.
And if memory is not enough, you can set `force_col_wise=true`.
[LightGBM] [Info] Total Bins 1448
[LightGBM] [Info] Number of data points in the train set: 4357, number of used features: 55
[LightGBM] [Info] Start training from score -1.259903
[LightGBM] [Info] Start training from score -1.518875
[LightGBM] [Info] Start training from score -3.186582
[LightGBM] [Info] Start training from score -2.243974
[LightGBM] [Info] Start training from score -1.049789
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
</pre></div>
</div>
<img alt="_images/af02b0bc0646c55b2954947262a994fee07f8312c30ac46dbd72ae1d10b6cd00.png" src="_images/af02b0bc0646c55b2954947262a994fee07f8312c30ac46dbd72ae1d10b6cd00.png" />
<img alt="_images/7da2f1d55be67531c6b4b9376fd60d329ccdeb472b752fc0c293a75a07f7852b.png" src="_images/7da2f1d55be67531c6b4b9376fd60d329ccdeb472b752fc0c293a75a07f7852b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Info] Auto-choosing row-wise multi-threading, the overhead of testing was 0.001305 seconds.
You can set `force_row_wise=true` to remove the overhead.
And if memory is not enough, you can set `force_col_wise=true`.
[LightGBM] [Info] Total Bins 1460
[LightGBM] [Info] Number of data points in the train set: 8435, number of used features: 58
[LightGBM] [Info] Start training from score -1.259424
[LightGBM] [Info] Start training from score -1.525345
[LightGBM] [Info] Start training from score -3.179359
[LightGBM] [Info] Start training from score -2.197462
[LightGBM] [Info] Start training from score -1.061491
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
</pre></div>
</div>
<img alt="_images/5fb8b36cc61e2e86bc2f443bb1fd3d218b64c84d40b41f93de9920f3bf2a70ca.png" src="_images/5fb8b36cc61e2e86bc2f443bb1fd3d218b64c84d40b41f93de9920f3bf2a70ca.png" />
<img alt="_images/674292a3ffe8a40a5c8092a05a759f5342b44ff0afc863212df03fc638911e5c.png" src="_images/674292a3ffe8a40a5c8092a05a759f5342b44ff0afc863212df03fc638911e5c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Info] Auto-choosing row-wise multi-threading, the overhead of testing was 0.002631 seconds.
You can set `force_row_wise=true` to remove the overhead.
And if memory is not enough, you can set `force_col_wise=true`.
[LightGBM] [Info] Total Bins 1475
[LightGBM] [Info] Number of data points in the train set: 13713, number of used features: 64
[LightGBM] [Info] Start training from score -1.256855
[LightGBM] [Info] Start training from score -1.523740
[LightGBM] [Info] Start training from score -3.173470
[LightGBM] [Info] Start training from score -2.210216
[LightGBM] [Info] Start training from score -1.061253
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
</pre></div>
</div>
<img alt="_images/a48fc63ce46051e9207842570a744ba60caec50f01b0149942e52bb75cfd0198.png" src="_images/a48fc63ce46051e9207842570a744ba60caec50f01b0149942e52bb75cfd0198.png" />
<img alt="_images/15dcca9047d31a6ab8a04cc547d7cf1837b957247cc7512ed39b6c7bf83bbac8.png" src="_images/15dcca9047d31a6ab8a04cc547d7cf1837b957247cc7512ed39b6c7bf83bbac8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Info] Auto-choosing row-wise multi-threading, the overhead of testing was 0.003549 seconds.
You can set `force_row_wise=true` to remove the overhead.
And if memory is not enough, you can set `force_col_wise=true`.
[LightGBM] [Info] Total Bins 1479
[LightGBM] [Info] Number of data points in the train set: 19545, number of used features: 65
[LightGBM] [Info] Start training from score -1.302751
[LightGBM] [Info] Start training from score -1.516666
[LightGBM] [Info] Start training from score -3.103968
[LightGBM] [Info] Start training from score -2.139376
[LightGBM] [Info] Start training from score -1.060809
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
</pre></div>
</div>
<img alt="_images/ccc072db1dafbdae253656cd4793131c172b66cc6277650e4008f3abf7636a95.png" src="_images/ccc072db1dafbdae253656cd4793131c172b66cc6277650e4008f3abf7636a95.png" />
<img alt="_images/8e2c78b6453b696930571191d346fe187f80bed93d1d4ce9b09ea6263c39cd55.png" src="_images/8e2c78b6453b696930571191d346fe187f80bed93d1d4ce9b09ea6263c39cd55.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Info] Auto-choosing row-wise multi-threading, the overhead of testing was 0.004409 seconds.
You can set `force_row_wise=true` to remove the overhead.
And if memory is not enough, you can set `force_col_wise=true`.
[LightGBM] [Info] Total Bins 1485
[LightGBM] [Info] Number of data points in the train set: 25440, number of used features: 66
[LightGBM] [Info] Start training from score -1.324413
[LightGBM] [Info] Start training from score -1.505021
[LightGBM] [Info] Start training from score -3.036653
[LightGBM] [Info] Start training from score -2.090509
[LightGBM] [Info] Start training from score -1.077608
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
/usr/local/lib/python3.10/dist-packages/sklearn/metrics/_classification.py:1531: UndefinedMetricWarning: Precision is ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, f&quot;{metric.capitalize()} is&quot;, len(result))
</pre></div>
</div>
<img alt="_images/543c6c12e5d20fc480c0f814ec58fcd219c47c5e000311f45cecfd45fe3acb3c.png" src="_images/543c6c12e5d20fc480c0f814ec58fcd219c47c5e000311f45cecfd45fe3acb3c.png" />
<img alt="_images/92097bebd66e28885ed9ee14b6340d9de701417084957ccc5691391454c25c3f.png" src="_images/92097bebd66e28885ed9ee14b6340d9de701417084957ccc5691391454c25c3f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Info] Auto-choosing row-wise multi-threading, the overhead of testing was 0.005667 seconds.
You can set `force_row_wise=true` to remove the overhead.
And if memory is not enough, you can set `force_col_wise=true`.
[LightGBM] [Info] Total Bins 1486
[LightGBM] [Info] Number of data points in the train set: 31350, number of used features: 66
[LightGBM] [Info] Start training from score -1.334880
[LightGBM] [Info] Start training from score -1.510510
[LightGBM] [Info] Start training from score -3.012783
[LightGBM] [Info] Start training from score -2.039853
[LightGBM] [Info] Start training from score -1.088236
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
[LightGBM] [Warning] feature_fraction is set=0.9751143272589864, colsample_bytree=1.0 will be ignored. Current value: feature_fraction=0.9751143272589864
</pre></div>
</div>
<img alt="_images/bb808a1c679d11bc6520287215173ee9f6179a8b3d9cb509b9402f6f22e57bc4.png" src="_images/bb808a1c679d11bc6520287215173ee9f6179a8b3d9cb509b9402f6f22e57bc4.png" />
<img alt="_images/1b5d2ac688d37f28090ec7341d807e85580880e7df01c00b1382233804884cc8.png" src="_images/1b5d2ac688d37f28090ec7341d807e85580880e7df01c00b1382233804884cc8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;Year&#39;: [2018.0, 2019.0, 2020.0, 2021.0, 2022.0, 2023.0], &#39;Accuracy&#39;: [0.4033840117704757, 0.4374763167866616, 0.4350137174211248, 0.44664970313825275, 0.4494077834179357, 0.46201443795118596], &#39;ROC AUC&#39;: [0.6595935640330692, 0.7056717170560928, 0.7105514066226701, 0.7286341466690432, 0.7226643537893764, 0.7390705939943881], &#39;F1 Score&#39;: [0.39084453150617715, 0.4242384362047083, 0.41734069498782317, 0.4253350713442557, 0.4265279546786609, 0.44033672984434646], &#39;Precision&#39;: [0.39496098165405324, 0.43538537760980267, 0.41931390569351995, 0.4247828908675572, 0.4313966051094394, 0.44124884719340035], &#39;Recall&#39;: [0.4033840117704757, 0.4374763167866616, 0.4350137174211248, 0.44664970313825275, 0.4494077834179357, 0.46201443795118596], &#39;Confusion Matrix&#39;: [array([[391, 263,   0,  34, 470],
       [147, 367,   6,  75, 286],
       [ 20,  75,   1,  26,  49],
       [ 65, 177,   4, 117, 112],
       [306, 287,   1,  30, 769]]), array([[ 504,  317,    1,   54,  632],
       [ 165,  562,    1,  112,  313],
       [  24,   96,    3,   50,   50],
       [  61,  204,    2,  188,  112],
       [ 366,  349,    2,   58, 1052]]), array([[ 375,  369,    2,   82,  582],
       [  90,  684,    3,  175,  349],
       [  14,  137,    0,   89,   63],
       [  53,  274,    2,  327,  141],
       [ 312,  462,    1,   95, 1151]]), array([[ 425,  329,    0,   59,  641],
       [ 121,  777,    1,  168,  292],
       [  29,  158,    0,   95,   62],
       [  53,  325,    0,  310,  156],
       [ 304,  405,    2,   62, 1121]]), array([[ 445,  334,    0,   52,  654],
       [ 124,  706,    0,  120,  324],
       [  32,  159,    0,   63,   66],
       [  97,  340,    0,  291,  204],
       [ 308,  333,    0,   44, 1214]]), array([[ 480,  371,    0,   44,  672],
       [ 114,  814,    0,  162,  275],
       [  35,  119,    0,   81,   50],
       [  73,  277,    1,  267,  158],
       [ 308,  339,    0,   51, 1127]])], &#39;Classification Report&#39;: [&#39;              precision    recall  f1-score   support\n\n           0       0.42      0.34      0.37      1158\n           1       0.31      0.42      0.36       881\n           2       0.08      0.01      0.01       171\n           3       0.41      0.25      0.31       475\n           4       0.46      0.55      0.50      1393\n\n    accuracy                           0.40      4078\n   macro avg       0.34      0.31      0.31      4078\nweighted avg       0.39      0.40      0.39      4078\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.45      0.33      0.38      1508\n           1       0.37      0.49      0.42      1153\n           2       0.33      0.01      0.03       223\n           3       0.41      0.33      0.37       567\n           4       0.49      0.58      0.53      1827\n\n    accuracy                           0.44      5278\n   macro avg       0.41      0.35      0.34      5278\nweighted avg       0.44      0.44      0.42      5278\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.44      0.27      0.33      1410\n           1       0.36      0.53      0.42      1301\n           2       0.00      0.00      0.00       303\n           3       0.43      0.41      0.42       797\n           4       0.50      0.57      0.53      2021\n\n    accuracy                           0.44      5832\n   macro avg       0.35      0.35      0.34      5832\nweighted avg       0.42      0.44      0.42      5832\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.46      0.29      0.36      1454\n           1       0.39      0.57      0.46      1359\n           2       0.00      0.00      0.00       344\n           3       0.45      0.37      0.40       844\n           4       0.49      0.59      0.54      1894\n\n    accuracy                           0.45      5895\n   macro avg       0.36      0.36      0.35      5895\nweighted avg       0.42      0.45      0.43      5895\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.44      0.30      0.36      1485\n           1       0.38      0.55      0.45      1274\n           2       0.00      0.00      0.00       320\n           3       0.51      0.31      0.39       932\n           4       0.49      0.64      0.56      1899\n\n    accuracy                           0.45      5910\n   macro avg       0.36      0.36      0.35      5910\nweighted avg       0.43      0.45      0.43      5910\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.48      0.31      0.37      1567\n           1       0.42      0.60      0.50      1365\n           2       0.00      0.00      0.00       285\n           3       0.44      0.34      0.39       776\n           4       0.49      0.62      0.55      1825\n\n    accuracy                           0.46      5818\n   macro avg       0.37      0.37      0.36      5818\nweighted avg       0.44      0.46      0.44      5818\n&#39;]}
</pre></div>
</div>
</div>
</div>
<p>Las métricas del modelo de <code class="docutils literal notranslate"><span class="pre">LightGBM</span></code> sobre los datos del modelo y agregando una columa adicional de la probabilidad de las etiquetas mal clasificadas refleja un desempeño un poco mejor en términos de AUC-ROC pero similar en cuanto a las otras métricas de clasificación, lo que sugiere que la metodología de stacking refleja un incremento <code class="docutils literal notranslate"><span class="pre">(0.66</span> <span class="pre">-</span> <span class="pre">0.74)</span></code> en la distinción de clases o clasificación en relación al modelo base, pero en detrimento del mismo estado de métricas generales, por lo que se sugiere utilizar o verificar otras metodlogías de ensamble o meta-modelaje.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Año&quot;</span><span class="p">:</span> <span class="n">years</span><span class="p">,</span>
    <span class="s2">&quot;Exactitud&quot;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
    <span class="s2">&quot;ROC AUC&quot;</span><span class="p">:</span> <span class="n">roc_auc</span><span class="p">,</span>
    <span class="s2">&quot;F1 Score&quot;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">,</span>
    <span class="s2">&quot;Precisión&quot;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
    <span class="s2">&quot;Recall&quot;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
    <span class="s2">&quot;Matriz de Confusión&quot;</span><span class="p">:</span> <span class="n">confusion_matrix_list</span><span class="p">,</span>
    <span class="s2">&quot;Reporte de Clasificación&quot;</span><span class="p">:</span> <span class="n">classification_report_list</span>
<span class="p">}</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Mostrar el DataFrame</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-ebcf24f4-4f9e-49c4-8e63-307e8363e442" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Año</th>
      <th>Exactitud</th>
      <th>ROC AUC</th>
      <th>F1 Score</th>
      <th>Precisión</th>
      <th>Recall</th>
      <th>Matriz de Confusión</th>
      <th>Reporte de Clasificación</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2018.0</td>
      <td>0.403384</td>
      <td>0.659594</td>
      <td>0.390845</td>
      <td>0.394961</td>
      <td>0.403384</td>
      <td>[[391, 263, 0, 34, 470], [147, 367, 6, 75, 286...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019.0</td>
      <td>0.437476</td>
      <td>0.705672</td>
      <td>0.424238</td>
      <td>0.435385</td>
      <td>0.437476</td>
      <td>[[504, 317, 1, 54, 632], [165, 562, 1, 112, 31...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020.0</td>
      <td>0.435014</td>
      <td>0.710551</td>
      <td>0.417341</td>
      <td>0.419314</td>
      <td>0.435014</td>
      <td>[[375, 369, 2, 82, 582], [90, 684, 3, 175, 349...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021.0</td>
      <td>0.446650</td>
      <td>0.728634</td>
      <td>0.425335</td>
      <td>0.424783</td>
      <td>0.446650</td>
      <td>[[425, 329, 0, 59, 641], [121, 777, 1, 168, 29...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2022.0</td>
      <td>0.449408</td>
      <td>0.722664</td>
      <td>0.426528</td>
      <td>0.431397</td>
      <td>0.449408</td>
      <td>[[445, 334, 0, 52, 654], [124, 706, 0, 120, 32...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2023.0</td>
      <td>0.462014</td>
      <td>0.739071</td>
      <td>0.440337</td>
      <td>0.441249</td>
      <td>0.462014</td>
      <td>[[480, 371, 0, 44, 672], [114, 814, 0, 162, 27...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-ebcf24f4-4f9e-49c4-8e63-307e8363e442')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-ebcf24f4-4f9e-49c4-8e63-307e8363e442 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-ebcf24f4-4f9e-49c4-8e63-307e8363e442');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-ad9f5423-17da-406e-aa65-f60c505841f3">
  <button class="colab-df-quickchart" onclick="quickchart('df-ad9f5423-17da-406e-aa65-f60c505841f3')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-ad9f5423-17da-406e-aa65-f60c505841f3 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div></div>
</div>
</section>
</section>
<section id="meta-modelaje-xgboost-ligthgbm">
<h2>Meta Modelaje - XGBoost + LigthGBM<a class="headerlink" href="#meta-modelaje-xgboost-ligthgbm" title="Link to this heading">#</a></h2>
<p>Se propone utilizar una combinación diferente de los modelos XGBoost y LigthGBM a través de un metamodelo que consiste en realizar las predicciones inciales con el modelo XGBoost y generar probabilidades de clasificación en esa categoría concatenadas inmediatamente en una nueva columna que será tomada por el ligthgbm como input para clasificaciones y predecir en conjunto la etiqueta final de clasificación.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Codificador de etiquetas para la variable objetivo</span>
<span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>

<span class="c1"># Definir las columnas categóricas y numéricas</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Estado actual&#39;</span><span class="p">,</span> <span class="s1">&#39;Concepto del Revisor fiscal en su orme&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;La compañía está obligada a tener Revisor fiscal?&#39;</span><span class="p">,</span> <span class="s1">&#39;Tipo societario&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Departamento de la dirección del domicilio&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Clasificación Industrial Internacional Uniforme Versión 4 A.C (CIIU)&#39;</span><span class="p">]</span>

<span class="n">numerical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cantidad de años de la empresa&#39;</span><span class="p">,</span> <span class="s1">&#39;Razón corriente&#39;</span><span class="p">,</span> <span class="s1">&#39;Rotación cartera&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;ROA&#39;</span><span class="p">,</span> <span class="s1">&#39;ROE&#39;</span><span class="p">,</span> <span class="s1">&#39;Generación Efectivo&#39;</span><span class="p">]</span>

<span class="c1"># Columnas a excluir</span>
<span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">,</span> <span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="s1">&#39;NIT&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="metricas-reelevantes-del-modelo">
<h3>Metricas reelevantes del modelo<a class="headerlink" href="#metricas-reelevantes-del-modelo" title="Link to this heading">#</a></h3>
</section>
<section id="resumen-de-metricas-por-ano">
<h3>Resumen de Métricas por Año<a class="headerlink" href="#resumen-de-metricas-por-ano" title="Link to this heading">#</a></h3>
<section id="ano-2018">
<h4>Año 2018:<a class="headerlink" href="#ano-2018" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Precisión</strong>: 0.90</p></li>
<li><p><strong>Recall</strong>: 0.89</p></li>
<li><p><strong>F1-Score</strong>: 0.89</p></li>
<li><p><strong>ROC AUC</strong>: 0.65</p></li>
<li><p><strong>Accuracy</strong>: 0.89</p></li>
</ul>
</section>
<section id="ano-2019">
<h4>Año 2019:<a class="headerlink" href="#ano-2019" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Precisión</strong>: 0.83</p></li>
<li><p><strong>Recall</strong>: 0.83</p></li>
<li><p><strong>F1-Score</strong>: 0.83</p></li>
<li><p><strong>ROC AUC</strong>: 0.68</p></li>
<li><p><strong>Accuracy</strong>: 0.83</p></li>
</ul>
</section>
<section id="ano-2020">
<h4>Año 2020:<a class="headerlink" href="#ano-2020" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Precisión</strong>: 0.82</p></li>
<li><p><strong>Recall</strong>: 0.81</p></li>
<li><p><strong>F1-Score</strong>: 0.81</p></li>
<li><p><strong>ROC AUC</strong>: 0.70</p></li>
<li><p><strong>Accuracy</strong>: 0.81</p></li>
</ul>
</section>
<section id="ano-2021">
<h4>Año 2021:<a class="headerlink" href="#ano-2021" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Precisión</strong>: 0.81</p></li>
<li><p><strong>Recall</strong>: 0.80</p></li>
<li><p><strong>F1-Score</strong>: 0.81</p></li>
<li><p><strong>ROC AUC</strong>: 0.71</p></li>
<li><p><strong>Accuracy</strong>: 0.81</p></li>
</ul>
</section>
<section id="ano-2022">
<h4>Año 2022:<a class="headerlink" href="#ano-2022" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Precisión</strong>: 0.80</p></li>
<li><p><strong>Recall</strong>: 0.79</p></li>
<li><p><strong>F1-Score</strong>: 0.79</p></li>
<li><p><strong>ROC AUC</strong>: 0.71</p></li>
<li><p><strong>Accuracy</strong>: 0.79</p></li>
</ul>
</section>
<section id="ano-2023">
<h4>Año 2023:<a class="headerlink" href="#ano-2023" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Precisión</strong>: 0.80</p></li>
<li><p><strong>Recall</strong>: 0.79</p></li>
<li><p><strong>F1-Score</strong>: 0.79</p></li>
<li><p><strong>ROC AUC</strong>: 0.73</p></li>
<li><p><strong>Accuracy</strong>: 0.79</p></li>
</ul>
<p>En general, se observa una ligera disminución en las métricas de precisión, recall y f1-score a lo largo de los años, con un desempeño relativamente estable en la precisión. El ROC AUC ha mostrado una mejora gradual en 2023, indicando una ligera mejora en la capacidad del modelo para diferenciar entre las clases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Preprocesador para las columnas numéricas y categóricas</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)),</span>  <span class="c1"># Imputación de valores faltantes</span>
    <span class="p">(</span><span class="s1">&#39;scaler&#39;</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">())</span>  <span class="c1"># Escalado de las características numéricas</span>
<span class="p">])</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;imputer&#39;</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;most_frequent&#39;</span><span class="p">)),</span>  <span class="c1"># Imputación de valores faltantes</span>
    <span class="p">(</span><span class="s1">&#39;onehot&#39;</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  <span class="c1"># Codificación OneHot</span>
<span class="p">])</span>

<span class="c1"># Combinamos todo en un ColumnTransformer</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numerical_columns</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_columns</span><span class="p">)</span>
    <span class="p">])</span>

<span class="c1"># Lista para almacenar los resultados de cada año</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;ROC AUC&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;F1 Score&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="p">[],</span>
           <span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Classification Report&#39;</span><span class="p">:</span> <span class="p">[]}</span>

<span class="c1"># Definir los años disponibles</span>
<span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ciclo para la validación secuencial por año</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)):</span>  <span class="c1"># Comenzamos desde el segundo año</span>
    <span class="c1"># Usamos los años anteriores para entrenamiento y el año actual para prueba</span>
    <span class="n">train_years</span> <span class="o">=</span> <span class="n">years</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># Datos de entrenamiento hasta el año i-1</span>
    <span class="n">test_year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="c1"># Año para prueba</span>

    <span class="c1"># Filtrar los datos de entrenamiento y prueba</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

    <span class="c1"># Codificar las etiquetas de la variable objetivo</span>
    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_test_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>

    <span class="c1"># Pipeline de XGBoost como modelo base</span>
    <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s1">&#39;multi:softprob&#39;</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train_encoded</span><span class="p">)),</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;mlogloss&#39;</span><span class="p">)</span>

    <span class="c1"># Crear el pipeline con preprocesador y el clasificador</span>
    <span class="n">pipeline_xgb</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  <span class="c1"># Preprocesamiento</span>
        <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">xgb_model</span><span class="p">)</span>  <span class="c1"># Clasificador XGBoost</span>
    <span class="p">])</span>

    <span class="c1"># Entrenamiento de XGBoost</span>
    <span class="n">pipeline_xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>

    <span class="c1"># Predicciones de XGBoost</span>
    <span class="n">y_pred_xgb_proba</span> <span class="o">=</span> <span class="n">pipeline_xgb</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>  <span class="c1"># Probabilidades de XGBoost</span>
    <span class="n">y_pred_xgb</span> <span class="o">=</span> <span class="n">pipeline_xgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>  <span class="c1"># Predicciones de XGBoost</span>

    <span class="c1"># Añadir las probabilidades de XGBoost como nuevas características para LightGBM</span>
    <span class="n">X_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_pred_xgb_proba</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;class_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_pred_xgb_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>

    <span class="c1"># Pipeline de LightGBM</span>
    <span class="n">lgb_model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s1">&#39;multiclass&#39;</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train_encoded</span><span class="p">)),</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;multi_logloss&#39;</span><span class="p">)</span>
    <span class="n">pipeline_lgb</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">lgb_model</span><span class="p">)</span>  <span class="c1"># Clasificador LightGBM</span>
    <span class="p">])</span>

    <span class="c1"># Entrenamiento de LightGBM con las predicciones de XGBoost</span>
    <span class="n">pipeline_lgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_meta</span><span class="p">,</span> <span class="n">y_test_encoded</span><span class="p">)</span>

    <span class="c1"># Predicciones finales con LightGBM</span>
    <span class="n">y_pred_final</span> <span class="o">=</span> <span class="n">pipeline_lgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_meta</span><span class="p">)</span>

    <span class="c1"># Calcular las métricas de evaluación</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_xgb_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>  <span class="c1"># Usamos las probabilidades para el cálculo de ROC AUC</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">)</span>
    <span class="n">class_report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">)</span>

    <span class="c1"># Guardar los resultados</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_year</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Classification Report&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_report</span><span class="p">)</span>

    <span class="c1"># Mostrar la matriz de confusión</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>

    <span class="c1"># Mostrar el reporte de clasificación</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">class_report</span><span class="p">)</span>

    <span class="c1"># Graficar la matriz de confusión como heatmap</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matriz de Confusión para </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicción&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Real&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Graficar la curva ROC</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_xgb_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Para la clase positiva</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AUC - </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC AUC para </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Imprimir los resultados finales</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados finales:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.006472 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 4078, number of used features: 5
[LightGBM] [Info] Start training from score -1.258912
[LightGBM] [Info] Start training from score -1.532304
[LightGBM] [Info] Start training from score -3.171698
[LightGBM] [Info] Start training from score -2.150047
[LightGBM] [Info] Start training from score -1.074147

Matriz de confusión para el año 2018.0:
[[1021   24    0   11  102]
 [  78  730    0    4   69]
 [   1    0  168    1    1]
 [  21   17    0  415   22]
 [  48   26    0    4 1315]]

Reporte de clasificación para el año 2018.0:
              precision    recall  f1-score   support

           0       0.87      0.88      0.88      1158
           1       0.92      0.83      0.87       881
           2       1.00      0.98      0.99       171
           3       0.95      0.87      0.91       475
           4       0.87      0.94      0.91      1393

    accuracy                           0.89      4078
   macro avg       0.92      0.90      0.91      4078
weighted avg       0.90      0.89      0.89      4078
</pre></div>
</div>
<img alt="_images/aa8f5c4f6ef6ff3fec3e523bcc4e0b4fee32862ee2c0cbff9f54b2f8f41ce20f.png" src="_images/aa8f5c4f6ef6ff3fec3e523bcc4e0b4fee32862ee2c0cbff9f54b2f8f41ce20f.png" />
<img alt="_images/524950f05bb1aaaa4f47c0d791ab789ec0b623674b7c6607649b12b4c40c8e5c.png" src="_images/524950f05bb1aaaa4f47c0d791ab789ec0b623674b7c6607649b12b4c40c8e5c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000388 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5278, number of used features: 5
[LightGBM] [Info] Start training from score -1.252763
[LightGBM] [Info] Start training from score -1.521180
[LightGBM] [Info] Start training from score -3.164131
[LightGBM] [Info] Start training from score -2.230943
[LightGBM] [Info] Start training from score -1.060872

Matriz de confusión para el año 2019.0:
[[1215   76    0   12  205]
 [ 102  915    2   19  115]
 [   3   14  198    6    2]
 [  27   36    1  452   51]
 [ 122   76    0   14 1615]]

Reporte de clasificación para el año 2019.0:
              precision    recall  f1-score   support

           0       0.83      0.81      0.82      1508
           1       0.82      0.79      0.81      1153
           2       0.99      0.89      0.93       223
           3       0.90      0.80      0.84       567
           4       0.81      0.88      0.85      1827

    accuracy                           0.83      5278
   macro avg       0.87      0.83      0.85      5278
weighted avg       0.83      0.83      0.83      5278
</pre></div>
</div>
<img alt="_images/ba24e10c3818de0868d6cd418256e1357a582b77afbd54c9f46861109910c06c.png" src="_images/ba24e10c3818de0868d6cd418256e1357a582b77afbd54c9f46861109910c06c.png" />
<img alt="_images/c83a3e61f210edb457213f6a42ba05a281768952e3c2171b72a603dfab0dab63.png" src="_images/c83a3e61f210edb457213f6a42ba05a281768952e3c2171b72a603dfab0dab63.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000657 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5832, number of used features: 5
[LightGBM] [Info] Start training from score -1.419770
[LightGBM] [Info] Start training from score -1.500227
[LightGBM] [Info] Start training from score -2.957382
[LightGBM] [Info] Start training from score -1.990261
[LightGBM] [Info] Start training from score -1.059768

Matriz de confusión para el año 2020.0:
[[1010  135    2   19  244]
 [  56 1084    1   40  120]
 [   2   22  254   19    6]
 [  25   82    0  625   65]
 [  93  125    3   34 1766]]

Reporte de clasificación para el año 2020.0:
              precision    recall  f1-score   support

           0       0.85      0.72      0.78      1410
           1       0.75      0.83      0.79      1301
           2       0.98      0.84      0.90       303
           3       0.85      0.78      0.81       797
           4       0.80      0.87      0.84      2021

    accuracy                           0.81      5832
   macro avg       0.85      0.81      0.82      5832
weighted avg       0.82      0.81      0.81      5832
</pre></div>
</div>
<img alt="_images/2e3fe690581e11b135597523ba597f33f8b7c97df97156911848d904f37d7348.png" src="_images/2e3fe690581e11b135597523ba597f33f8b7c97df97156911848d904f37d7348.png" />
<img alt="_images/ad3f868c6b3e30de75d4cec23321648ce3fc21391c01ed7c0a221a0906679c33.png" src="_images/ad3f868c6b3e30de75d4cec23321648ce3fc21391c01ed7c0a221a0906679c33.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000623 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5895, number of used features: 5
[LightGBM] [Info] Start training from score -1.399786
[LightGBM] [Info] Start training from score -1.467355
[LightGBM] [Info] Start training from score -2.841218
[LightGBM] [Info] Start training from score -1.943707
[LightGBM] [Info] Start training from score -1.135414

Matriz de confusión para el año 2021.0:
[[1111  124    3   16  200]
 [  72 1149    0   45   93]
 [   8   54  248   22   12]
 [  23  124    0  642   55]
 [ 118  150    0   19 1607]]

Reporte de clasificación para el año 2021.0:
              precision    recall  f1-score   support

           0       0.83      0.76      0.80      1454
           1       0.72      0.85      0.78      1359
           2       0.99      0.72      0.83       344
           3       0.86      0.76      0.81       844
           4       0.82      0.85      0.83      1894

    accuracy                           0.81      5895
   macro avg       0.84      0.79      0.81      5895
weighted avg       0.81      0.81      0.81      5895
</pre></div>
</div>
<img alt="_images/e79ebacfc61101308b9fc042507a02ae66deb5c98bca4a13ddc69e6afa516cb4.png" src="_images/e79ebacfc61101308b9fc042507a02ae66deb5c98bca4a13ddc69e6afa516cb4.png" />
<img alt="_images/4a72e73a5203bc04efccbda4a02579a51fcea3fe22f72cc5989f0d87a4bc88ec.png" src="_images/4a72e73a5203bc04efccbda4a02579a51fcea3fe22f72cc5989f0d87a4bc88ec.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000428 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5910, number of used features: 5
[LightGBM] [Info] Start training from score -1.381231
[LightGBM] [Info] Start training from score -1.534484
[LightGBM] [Info] Start training from score -2.916080
[LightGBM] [Info] Start training from score -1.847068
[LightGBM] [Info] Start training from score -1.135318

Matriz de confusión para el año 2022.0:
[[1080  112    0   31  262]
 [  95  998    2   68  111]
 [   9   48  233   18   12]
 [  45   89    0  718   80]
 [ 102  124    0   15 1658]]

Reporte de clasificación para el año 2022.0:
              precision    recall  f1-score   support

           0       0.81      0.73      0.77      1485
           1       0.73      0.78      0.75      1274
           2       0.99      0.73      0.84       320
           3       0.84      0.77      0.81       932
           4       0.78      0.87      0.82      1899

    accuracy                           0.79      5910
   macro avg       0.83      0.78      0.80      5910
weighted avg       0.80      0.79      0.79      5910
</pre></div>
</div>
<img alt="_images/b51167f8d3bdd75222cb0b3574d0896ca66dd6b49b02c1fde71427418646ae0b.png" src="_images/b51167f8d3bdd75222cb0b3574d0896ca66dd6b49b02c1fde71427418646ae0b.png" />
<img alt="_images/32e715a1203b6ad3ff41fc9fbe8b8f2b29836de1f3a64d6b640e5d020b204f87.png" src="_images/32e715a1203b6ad3ff41fc9fbe8b8f2b29836de1f3a64d6b640e5d020b204f87.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.002719 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5818, number of used features: 5
[LightGBM] [Info] Start training from score -1.311794
[LightGBM] [Info] Start training from score -1.449802
[LightGBM] [Info] Start training from score -3.016223
[LightGBM] [Info] Start training from score -2.014559
[LightGBM] [Info] Start training from score -1.159377

Matriz de confusión para el año 2023.0:
[[1178  183    1   18  187]
 [  93 1159    1   37   75]
 [   4   37  226   16    2]
 [  51  127    1  557   40]
 [ 194  155    0   13 1463]]

Reporte de clasificación para el año 2023.0:
              precision    recall  f1-score   support

           0       0.78      0.75      0.76      1567
           1       0.70      0.85      0.77      1365
           2       0.99      0.79      0.88       285
           3       0.87      0.72      0.79       776
           4       0.83      0.80      0.81      1825

    accuracy                           0.79      5818
   macro avg       0.83      0.78      0.80      5818
weighted avg       0.80      0.79      0.79      5818
</pre></div>
</div>
<img alt="_images/ffaa45c35e8ec6fdd1d4a54d55a227f73da6eda4a9e1be93e6f397a8075feb45.png" src="_images/ffaa45c35e8ec6fdd1d4a54d55a227f73da6eda4a9e1be93e6f397a8075feb45.png" />
<img alt="_images/d1a2f670a7660e4359836ba5ce24b599802c70285ff6cac5dec73cd2312656a5.png" src="_images/d1a2f670a7660e4359836ba5ce24b599802c70285ff6cac5dec73cd2312656a5.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados finales:
{&#39;Year&#39;: [2018.0, 2019.0, 2020.0, 2021.0, 2022.0, 2023.0], &#39;Accuracy&#39;: [0.8948013732221677, 0.832701780977643, 0.8125857338820301, 0.8069550466497032, 0.7930626057529611, 0.7877277414919216], &#39;ROC AUC&#39;: [0.6488762224899749, 0.6820701090356294, 0.697629609710547, 0.7145356483603204, 0.707111788472079, 0.7313980736980332], &#39;F1 Score&#39;: [0.894527183186362, 0.8326224288376552, 0.8121978500838001, 0.8075522063793523, 0.7928674644963716, 0.7887375490610025], &#39;Precision&#39;: [0.896617280484168, 0.8346223312613679, 0.8175885248443465, 0.8148634050889296, 0.7986385836029206, 0.7964044577360111], &#39;Recall&#39;: [0.8948013732221677, 0.832701780977643, 0.8125857338820301, 0.8069550466497032, 0.7930626057529611, 0.7877277414919216], &#39;Confusion Matrix&#39;: [array([[1021,   24,    0,   11,  102],
       [  78,  730,    0,    4,   69],
       [   1,    0,  168,    1,    1],
       [  21,   17,    0,  415,   22],
       [  48,   26,    0,    4, 1315]]), array([[1215,   76,    0,   12,  205],
       [ 102,  915,    2,   19,  115],
       [   3,   14,  198,    6,    2],
       [  27,   36,    1,  452,   51],
       [ 122,   76,    0,   14, 1615]]), array([[1010,  135,    2,   19,  244],
       [  56, 1084,    1,   40,  120],
       [   2,   22,  254,   19,    6],
       [  25,   82,    0,  625,   65],
       [  93,  125,    3,   34, 1766]]), array([[1111,  124,    3,   16,  200],
       [  72, 1149,    0,   45,   93],
       [   8,   54,  248,   22,   12],
       [  23,  124,    0,  642,   55],
       [ 118,  150,    0,   19, 1607]]), array([[1080,  112,    0,   31,  262],
       [  95,  998,    2,   68,  111],
       [   9,   48,  233,   18,   12],
       [  45,   89,    0,  718,   80],
       [ 102,  124,    0,   15, 1658]]), array([[1178,  183,    1,   18,  187],
       [  93, 1159,    1,   37,   75],
       [   4,   37,  226,   16,    2],
       [  51,  127,    1,  557,   40],
       [ 194,  155,    0,   13, 1463]])], &#39;Classification Report&#39;: [&#39;              precision    recall  f1-score   support\n\n           0       0.87      0.88      0.88      1158\n           1       0.92      0.83      0.87       881\n           2       1.00      0.98      0.99       171\n           3       0.95      0.87      0.91       475\n           4       0.87      0.94      0.91      1393\n\n    accuracy                           0.89      4078\n   macro avg       0.92      0.90      0.91      4078\nweighted avg       0.90      0.89      0.89      4078\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.83      0.81      0.82      1508\n           1       0.82      0.79      0.81      1153\n           2       0.99      0.89      0.93       223\n           3       0.90      0.80      0.84       567\n           4       0.81      0.88      0.85      1827\n\n    accuracy                           0.83      5278\n   macro avg       0.87      0.83      0.85      5278\nweighted avg       0.83      0.83      0.83      5278\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.85      0.72      0.78      1410\n           1       0.75      0.83      0.79      1301\n           2       0.98      0.84      0.90       303\n           3       0.85      0.78      0.81       797\n           4       0.80      0.87      0.84      2021\n\n    accuracy                           0.81      5832\n   macro avg       0.85      0.81      0.82      5832\nweighted avg       0.82      0.81      0.81      5832\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.83      0.76      0.80      1454\n           1       0.72      0.85      0.78      1359\n           2       0.99      0.72      0.83       344\n           3       0.86      0.76      0.81       844\n           4       0.82      0.85      0.83      1894\n\n    accuracy                           0.81      5895\n   macro avg       0.84      0.79      0.81      5895\nweighted avg       0.81      0.81      0.81      5895\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.81      0.73      0.77      1485\n           1       0.73      0.78      0.75      1274\n           2       0.99      0.73      0.84       320\n           3       0.84      0.77      0.81       932\n           4       0.78      0.87      0.82      1899\n\n    accuracy                           0.79      5910\n   macro avg       0.83      0.78      0.80      5910\nweighted avg       0.80      0.79      0.79      5910\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.78      0.75      0.76      1567\n           1       0.70      0.85      0.77      1365\n           2       0.99      0.79      0.88       285\n           3       0.87      0.72      0.79       776\n           4       0.83      0.80      0.81      1825\n\n    accuracy                           0.79      5818\n   macro avg       0.83      0.78      0.80      5818\nweighted avg       0.80      0.79      0.79      5818\n&#39;]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Crear un DataFrame con las métricas</span>
<span class="n">df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">years</span><span class="p">,</span>
    <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
    <span class="s1">&#39;ROC AUC&#39;</span><span class="p">:</span> <span class="n">roc_auc</span><span class="p">,</span>
    <span class="s1">&#39;F1 Score&#39;</span><span class="p">:</span> <span class="n">f1_score</span><span class="p">,</span>
    <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
    <span class="s1">&#39;Recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
    <span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">:</span> <span class="n">confusion_matrix_list</span><span class="p">,</span>
    <span class="s1">&#39;Classification Report&#39;</span><span class="p">:</span> <span class="n">classification_report_list</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>A lo largo del análisis de las métricas de desempeño por año, se observa una ligera tendencia a la disminución en las métricas clave como precisión, recall, y f1-score desde 2018 hasta 2023. Aunque la precisión se mantiene relativamente alta (siempre superior al 80%), el <strong>recall</strong> y el <strong>f1-score</strong> han experimentado una ligera caída. Esta disminución podría estar relacionada con un ajuste en la distribución de clases o cambios en las características de los datos a lo largo de los años. Por otro lado, el <strong>ROC AUC</strong> muestra una tendencia positiva, lo que sugiere que, aunque las métricas de clasificación (precisión, recall) bajan un poco, el modelo se ha vuelto más eficaz a la hora de distinguir entre clases a lo largo del tiempo.</p>
<p>Las <strong>matrices de confusión</strong> para cada año proporcionan más detalles sobre el comportamiento del modelo en términos de verdaderos positivos (TP), verdaderos negativos (TN), falsos positivos (FP) y falsos negativos (FN).</p>
</section>
<section id="matriz-de-confusion-ano-2018">
<h4>Matriz de Confusión - Año 2018<a class="headerlink" href="#matriz-de-confusion-ano-2018" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Observaciones</strong>: En 2018, el modelo presenta una tasa baja de falsos negativos (FN) y falsos positivos (FP), lo que refleja un desempeño sólido. La mayoría de las predicciones son correctas, lo que contribuye a las métricas de precisión y recall altas.</p></li>
</ul>
</section>
<section id="matriz-de-confusion-ano-2019">
<h4>Matriz de Confusión - Año 2019<a class="headerlink" href="#matriz-de-confusion-ano-2019" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Observaciones</strong>: En 2019, se observa un aumento en los falsos negativos y falsos positivos en comparación con 2018. Esto podría indicar que el modelo tuvo un rendimiento ligeramente inferior en cuanto a su capacidad para clasificar correctamente las instancias.</p></li>
</ul>
</section>
<section id="matriz-de-confusion-ano-2020">
<h4>Matriz de Confusión - Año 2020<a class="headerlink" href="#matriz-de-confusion-ano-2020" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Observaciones</strong>: En 2020, tanto los falsos negativos como los falsos positivos aumentan, lo que refleja una caída en el desempeño del modelo en comparación con años anteriores. Esto es consistente con la disminución de las métricas de precisión y recall.</p></li>
</ul>
</section>
<section id="matriz-de-confusion-ano-2021">
<h4>Matriz de Confusión - Año 2021<a class="headerlink" href="#matriz-de-confusion-ano-2021" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Observaciones</strong>: En 2021, las métricas siguen la tendencia de disminución, y la matriz de confusión muestra un ligero aumento en los falsos positivos y falsos negativos, lo que implica una pérdida de precisión en las predicciones del modelo.</p></li>
</ul>
</section>
<section id="matriz-de-confusion-ano-2022">
<h4>Matriz de Confusión - Año 2022<a class="headerlink" href="#matriz-de-confusion-ano-2022" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Observaciones</strong>: En 2022, los falsos positivos y falsos negativos siguen creciendo, lo que refleja una mayor dificultad del modelo para hacer predicciones correctas. La caída en las métricas de precisión y recall sigue siendo notable.</p></li>
</ul>
</section>
<section id="matriz-de-confusion-ano-2023">
<h4>Matriz de Confusión - Año 2023<a class="headerlink" href="#matriz-de-confusion-ano-2023" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Observaciones</strong>: En 2023, el modelo muestra una ligera mejora en comparación con 2022, con una disminución en los falsos negativos, lo que podría contribuir a la mejora en el ROC AUC. Sin embargo, el desempeño general sigue siendo ligeramente inferior a los primeros años.</p></li>
</ul>
</section>
</section>
<section id="conclusion-general">
<h3>Conclusión General<a class="headerlink" href="#conclusion-general" title="Link to this heading">#</a></h3>
<p>A lo largo de los años, las métricas del modelo reflejan una ligera disminución en su capacidad de clasificación. Aunque el <strong>accuracy</strong> y <strong>precisión</strong> se mantienen relativamente altos, el <strong>recall</strong> y <strong>f1-score</strong> bajan, lo que indica que el modelo ha tenido más dificultades para identificar correctamente todas las clases a medida que avanzan los años. Las matrices de confusión muestran una tendencia al aumento en los falsos positivos y negativos, lo que coincide con la caída en las métricas de rendimiento. Sin embargo, el incremento en el <strong>ROC AUC</strong> de 2023 sugiere que el modelo ha mejorado su capacidad para diferenciar entre clases a pesar de esta tendencia.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mostrar el DataFrame</span>
<span class="n">df_metrics</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-33975813-5c81-4ee7-9a55-6af81696b438" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Year</th>
      <th>Accuracy</th>
      <th>ROC AUC</th>
      <th>F1 Score</th>
      <th>Precision</th>
      <th>Recall</th>
      <th>Confusion Matrix</th>
      <th>Classification Report</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2018.0</td>
      <td>0.894801</td>
      <td>0.648876</td>
      <td>0.894527</td>
      <td>0.896617</td>
      <td>0.894801</td>
      <td>[[1021, 24, 0, 11, 102], [78, 730, 0, 4, 69], ...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2019.0</td>
      <td>0.832702</td>
      <td>0.682070</td>
      <td>0.832622</td>
      <td>0.834622</td>
      <td>0.832702</td>
      <td>[[1215, 76, 0, 12, 205], [102, 915, 2, 19, 115...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020.0</td>
      <td>0.812586</td>
      <td>0.697630</td>
      <td>0.812198</td>
      <td>0.817589</td>
      <td>0.812586</td>
      <td>[[1010, 135, 2, 19, 244], [56, 1084, 1, 40, 12...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021.0</td>
      <td>0.806955</td>
      <td>0.714536</td>
      <td>0.807552</td>
      <td>0.814863</td>
      <td>0.806955</td>
      <td>[[1111, 124, 3, 16, 200], [72, 1149, 0, 45, 93...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2022.0</td>
      <td>0.793063</td>
      <td>0.707112</td>
      <td>0.792867</td>
      <td>0.798639</td>
      <td>0.793063</td>
      <td>[[1080, 112, 0, 31, 262], [95, 998, 2, 68, 111...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2023.0</td>
      <td>0.787728</td>
      <td>0.731398</td>
      <td>0.788738</td>
      <td>0.796404</td>
      <td>0.787728</td>
      <td>[[1178, 183, 1, 18, 187], [93, 1159, 1, 37, 75...</td>
      <td>precision    recall  f1-score   support\n\n   ...</td>
    </tr>
  </tbody>
</table>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-33975813-5c81-4ee7-9a55-6af81696b438')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-33975813-5c81-4ee7-9a55-6af81696b438 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-33975813-5c81-4ee7-9a55-6af81696b438');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-887be48c-c052-483d-8ae5-c775427f1ed8">
  <button class="colab-df-quickchart" onclick="quickchart('df-887be48c-c052-483d-8ae5-c775427f1ed8')"
            title="Suggest charts"
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-887be48c-c052-483d-8ae5-c775427f1ed8 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Crear un DataFrame con las métricas</span>
<span class="n">metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metric_results</span><span class="p">)</span>

<span class="c1"># Graficar las métricas con líneas para evaluar el desempeño a lo largo de los años</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Graficar precisión</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precisión por Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Precisión&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Graficar AUC ROC</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;AUC ROC por Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;AUC ROC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Graficar F1 Score</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;F1 Score por Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Graficar Precision</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Precisión por Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Precisión&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Graficar Recall</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">],</span> <span class="n">metrics_df</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Recall por Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Recall&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Mostrar la gráfica</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/062267d33e39e785d021af28706b799cbafb55e2867f984c184411eaa326b7a5.png" src="_images/062267d33e39e785d021af28706b799cbafb55e2867f984c184411eaa326b7a5.png" />
</div>
</div>
<section id="variables-de-interes">
<h4>Variables de interés<a class="headerlink" href="#variables-de-interes" title="Link to this heading">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Características</span> <span class="pre">más</span> <span class="pre">importantes</span> <span class="pre">para</span> <span class="pre">2019:</span></code></p>
<ul class="simple">
<li><p><strong>Estado Actual</strong>: El <strong>Acuerdo de Reestructuración</strong> y el estado <strong>Activo</strong> son altamente relevantes, lo que sugiere que el estado financiero y contractual tiene un impacto significativo en la clasificación de las empresas.</p></li>
<li><p><strong>Ubicación Geográfica</strong>: Variables como el <strong>Departamento de la Dirección del Domicilio</strong>, especialmente <strong>Bolívar</strong> y <strong>Huila</strong>, son influyentes, indicando que la ubicación geográfica tiene un efecto considerable en las predicciones.</p></li>
<li><p><strong>Indicadores Financieros</strong>: El <strong>ROA (Return on Assets)</strong> destaca como un indicador clave de rentabilidad, subrayando la importancia de los factores financieros en la clasificación empresarial.</p></li>
<li><p><strong>Clasificación de la Empresa</strong>: La <strong>Clasificación Industrial Internacional Uniforme (CIIU)</strong> es otra variable importante, con sectores como <strong>Alojamiento y Servicios de Comida</strong>, <strong>Agricultura y Ganadería</strong>, y <strong>Actividades Financieras y de Seguros</strong> siendo especialmente relevantes.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Características</span> <span class="pre">más</span> <span class="pre">importantes</span> <span class="pre">para</span> <span class="pre">2020:</span></code></p>
<ul class="simple">
<li><p><strong>Estado Actual</strong>: La variable <strong>Acuerdo de Reorganización</strong> es más relevante en 2020, indicando la importancia de las reestructuraciones empresariales.</p></li>
<li><p><strong>Ubicación Geográfica</strong>: Se destacan departamentos como <strong>Boyacá</strong>, además de <strong>Huila</strong>, que mantiene su relevancia.</p></li>
<li><p><strong>Clasificación Industrial Internacional Uniforme (CIIU)</strong>: Las categorías de <strong>Agricultura, Ganadería, Caza, Silvicultura y Pesca</strong>, y <strong>Actividades Inmobiliarias</strong> son especialmente importantes en 2020.</p></li>
<li><p><strong>Indicadores Financieros</strong>: El <strong>ROA</strong> y la <strong>Generación de Efectivo</strong> siguen siendo factores clave.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Características</span> <span class="pre">más</span> <span class="pre">importantes</span> <span class="pre">para</span> <span class="pre">2021:</span></code></p>
<ul class="simple">
<li><p><strong>Estado Actual</strong>: El estado <strong>Activo</strong> y <strong>Acuerdo de Reorganización</strong> tienen una gran influencia en las predicciones.</p></li>
<li><p><strong>Ubicación Geográfica</strong>: Se observan los departamentos de <strong>Cundinamarca</strong>, <strong>Meta</strong>, además de <strong>Huila</strong> y <strong>Bolívar</strong>, lo que resalta la importancia de la localización empresarial.</p></li>
<li><p><strong>Clasificación Industrial Internacional Uniforme (CIIU)</strong>: Sectores como <strong>Agricultura, Ganadería, Caza, Silvicultura y Pesca</strong> y <strong>Actividades Inmobiliarias</strong> siguen siendo relevantes.</p></li>
<li><p><strong>Revisor Fiscal</strong>: La variable <strong>Concepto del Revisor Fiscal</strong> también es relevante, especialmente con valores como <strong>No Aplica</strong>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Crear un diccionario para almacenar las importancias de las características por año</span>
<span class="n">feature_importances</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Ciclo para la validación secuencial por año</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)):</span>  <span class="c1"># Comenzamos desde el segundo año</span>
    <span class="c1"># Usamos los años anteriores para entrenamiento y el año actual para prueba</span>
    <span class="n">train_years</span> <span class="o">=</span> <span class="n">years</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># Datos de entrenamiento hasta el año i-1</span>
    <span class="n">test_year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="c1"># Año para prueba</span>

    <span class="c1"># Filtrar los datos de entrenamiento y prueba</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">)</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_years</span><span class="p">)][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">exclude_columns</span><span class="p">)</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_year</span><span class="p">][</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">]</span>

    <span class="c1"># Codificar las etiquetas de la variable objetivo</span>
    <span class="n">y_train_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
    <span class="n">y_test_encoded</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span>

    <span class="c1"># Pipeline de XGBoost como modelo base</span>
    <span class="n">xgb_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s1">&#39;multi:softprob&#39;</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train_encoded</span><span class="p">)),</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;mlogloss&#39;</span><span class="p">)</span>

    <span class="c1"># Crear el pipeline con preprocesador y el clasificador</span>
    <span class="n">pipeline_xgb</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>  <span class="c1"># Preprocesamiento</span>
        <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">xgb_model</span><span class="p">)</span>  <span class="c1"># Clasificador XGBoost</span>
    <span class="p">])</span>

    <span class="c1"># Entrenamiento de XGBoost</span>
    <span class="n">pipeline_xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_encoded</span><span class="p">)</span>

    <span class="c1"># Predicciones de XGBoost</span>
    <span class="n">y_pred_xgb_proba</span> <span class="o">=</span> <span class="n">pipeline_xgb</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>  <span class="c1"># Probabilidades de XGBoost</span>
    <span class="n">y_pred_xgb</span> <span class="o">=</span> <span class="n">pipeline_xgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>  <span class="c1"># Predicciones de XGBoost</span>

    <span class="c1"># Añadir las probabilidades de XGBoost como nuevas características para LightGBM</span>
    <span class="n">X_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y_pred_xgb_proba</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;class_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_pred_xgb_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>

    <span class="c1"># Pipeline de LightGBM</span>
    <span class="n">lgb_model</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">objective</span><span class="o">=</span><span class="s1">&#39;multiclass&#39;</span><span class="p">,</span> <span class="n">num_class</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train_encoded</span><span class="p">)),</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;multi_logloss&#39;</span><span class="p">)</span>
    <span class="n">pipeline_lgb</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">lgb_model</span><span class="p">)</span>  <span class="c1"># Clasificador LightGBM</span>
    <span class="p">])</span>

    <span class="c1"># Entrenamiento de LightGBM con las predicciones de XGBoost</span>
    <span class="n">pipeline_lgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_meta</span><span class="p">,</span> <span class="n">y_test_encoded</span><span class="p">)</span>

    <span class="c1"># Predicciones finales con LightGBM</span>
    <span class="n">y_pred_final</span> <span class="o">=</span> <span class="n">pipeline_lgb</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_meta</span><span class="p">)</span>

    <span class="c1"># Calcular las métricas de evaluación</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">)</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_xgb_proba</span><span class="p">,</span> <span class="n">multi_class</span><span class="o">=</span><span class="s1">&#39;ovr&#39;</span><span class="p">)</span>  <span class="c1"># Usamos las probabilidades para el cálculo de ROC AUC</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;weighted&#39;</span><span class="p">)</span>
    <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">)</span>
    <span class="n">class_report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">)</span>

    <span class="c1"># Guardar los resultados</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_year</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;ROC AUC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Confusion Matrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>
    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Classification Report&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_report</span><span class="p">)</span>

     <span class="c1"># Obtener la importancia de las características de XGBoost</span>
    <span class="n">xgb_importance</span> <span class="o">=</span> <span class="n">pipeline_xgb</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;classifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span>

    <span class="c1"># Get feature names after preprocessing</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">pipeline_xgb</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>

    <span class="c1"># Create Series with correct index</span>
    <span class="n">feature_importances</span><span class="p">[</span><span class="n">test_year</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">xgb_importance</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Graficar la importancia de las características para XGBoost</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">feature_importances</span><span class="p">[</span><span class="n">test_year</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Importancia de Características de XGBoost para </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Características&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Mostrar la matriz de confusión</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Matriz de confusión para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>

    <span class="c1"># Mostrar el reporte de clasificación</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reporte de clasificación para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">class_report</span><span class="p">)</span>

    <span class="c1"># Graficar la curva ROC</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">,</span> <span class="n">y_pred_xgb_proba</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos_label</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Para la clase positiva</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;AUC - </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Curva ROC AUC para </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Imprimir los resultados finales</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resultados finales:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000414 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5278, number of used features: 5
[LightGBM] [Info] Start training from score -1.252763
[LightGBM] [Info] Start training from score -1.521180
[LightGBM] [Info] Start training from score -3.164131
[LightGBM] [Info] Start training from score -2.230943
[LightGBM] [Info] Start training from score -1.060872
</pre></div>
</div>
<img alt="_images/cdf9ca069896f4b152e1d17f519e8008645dc1219937e8c1c23971381601fe77.png" src="_images/cdf9ca069896f4b152e1d17f519e8008645dc1219937e8c1c23971381601fe77.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de confusión para el año 2019.0:
[[1225   71    0   15  197]
 [  85  934    0   20  114]
 [   1    5  215    2    0]
 [  25   50    1  453   38]
 [  99   93    0   12 1623]]

Reporte de clasificación para el año 2019.0:
              precision    recall  f1-score   support

           0       0.85      0.81      0.83      1508
           1       0.81      0.81      0.81      1153
           2       1.00      0.96      0.98       223
           3       0.90      0.80      0.85       567
           4       0.82      0.89      0.85      1827

    accuracy                           0.84      5278
   macro avg       0.88      0.85      0.86      5278
weighted avg       0.84      0.84      0.84      5278
</pre></div>
</div>
<img alt="_images/e9d4521e0b9e22a5095cd811622ed017c420adc75c2c165d35476f5534254ed1.png" src="_images/e9d4521e0b9e22a5095cd811622ed017c420adc75c2c165d35476f5534254ed1.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000531 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5832, number of used features: 5
[LightGBM] [Info] Start training from score -1.419770
[LightGBM] [Info] Start training from score -1.500227
[LightGBM] [Info] Start training from score -2.957382
[LightGBM] [Info] Start training from score -1.990261
[LightGBM] [Info] Start training from score -1.059768
</pre></div>
</div>
<img alt="_images/469538add21361ac89334cdebb04091587bb463b43ad59ca6be65272a7c29f24.png" src="_images/469538add21361ac89334cdebb04091587bb463b43ad59ca6be65272a7c29f24.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de confusión para el año 2020.0:
[[ 986  159    2   26  237]
 [  63 1084    0   38  116]
 [   4   26  248   16    9]
 [  23   75    1  623   75]
 [  70  142    1   33 1775]]

Reporte de clasificación para el año 2020.0:
              precision    recall  f1-score   support

           0       0.86      0.70      0.77      1410
           1       0.73      0.83      0.78      1301
           2       0.98      0.82      0.89       303
           3       0.85      0.78      0.81       797
           4       0.80      0.88      0.84      2021

    accuracy                           0.81      5832
   macro avg       0.84      0.80      0.82      5832
weighted avg       0.82      0.81      0.81      5832
</pre></div>
</div>
<img alt="_images/3464bce17563ea6ea1af6ad66d0fb492aaa3dd43c6968eedf54dff56ee8a9d5f.png" src="_images/3464bce17563ea6ea1af6ad66d0fb492aaa3dd43c6968eedf54dff56ee8a9d5f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000567 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5895, number of used features: 5
[LightGBM] [Info] Start training from score -1.399786
[LightGBM] [Info] Start training from score -1.467355
[LightGBM] [Info] Start training from score -2.841218
[LightGBM] [Info] Start training from score -1.943707
[LightGBM] [Info] Start training from score -1.135414
</pre></div>
</div>
<img alt="_images/6159237318997062381af8b2c28610744f4d3f2c5792236249e533e3ae2cb273.png" src="_images/6159237318997062381af8b2c28610744f4d3f2c5792236249e533e3ae2cb273.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de confusión para el año 2021.0:
[[1068  144    1   42  199]
 [  80 1139    1   52   87]
 [   3   33  269   31    8]
 [  23   88    0  672   61]
 [ 121  133    1   30 1609]]

Reporte de clasificación para el año 2021.0:
              precision    recall  f1-score   support

           0       0.82      0.73      0.78      1454
           1       0.74      0.84      0.79      1359
           2       0.99      0.78      0.87       344
           3       0.81      0.80      0.80       844
           4       0.82      0.85      0.83      1894

    accuracy                           0.81      5895
   macro avg       0.84      0.80      0.82      5895
weighted avg       0.81      0.81      0.81      5895
</pre></div>
</div>
<img alt="_images/d505c4ebf062056de84342d51fa2f041e6152406e7b2387d6449738be9a5ad66.png" src="_images/d505c4ebf062056de84342d51fa2f041e6152406e7b2387d6449738be9a5ad66.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000610 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5910, number of used features: 5
[LightGBM] [Info] Start training from score -1.381231
[LightGBM] [Info] Start training from score -1.534484
[LightGBM] [Info] Start training from score -2.916080
[LightGBM] [Info] Start training from score -1.847068
[LightGBM] [Info] Start training from score -1.135318
</pre></div>
</div>
<img alt="_images/b2d03954ecad2c3d3299b7b6a1ebb8cb3e786a8191157e005e0efef5abe072a8.png" src="_images/b2d03954ecad2c3d3299b7b6a1ebb8cb3e786a8191157e005e0efef5abe072a8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de confusión para el año 2022.0:
[[1112  122    1   24  226]
 [  92 1017    0   72   93]
 [  11   39  246   21    3]
 [  57   80    4  700   91]
 [ 145  135    1   24 1594]]

Reporte de clasificación para el año 2022.0:
              precision    recall  f1-score   support

           0       0.78      0.75      0.77      1485
           1       0.73      0.80      0.76      1274
           2       0.98      0.77      0.86       320
           3       0.83      0.75      0.79       932
           4       0.79      0.84      0.82      1899

    accuracy                           0.79      5910
   macro avg       0.82      0.78      0.80      5910
weighted avg       0.79      0.79      0.79      5910
</pre></div>
</div>
<img alt="_images/0467debbbd96c72f576487c929ca26f97f908272eb34f11feff153e147d51196.png" src="_images/0467debbbd96c72f576487c929ca26f97f908272eb34f11feff153e147d51196.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000461 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 1275
[LightGBM] [Info] Number of data points in the train set: 5818, number of used features: 5
[LightGBM] [Info] Start training from score -1.311794
[LightGBM] [Info] Start training from score -1.449802
[LightGBM] [Info] Start training from score -3.016223
[LightGBM] [Info] Start training from score -2.014559
[LightGBM] [Info] Start training from score -1.159377
</pre></div>
</div>
<img alt="_images/61aee8e5d9d185b34415e52229b430d77a0f62315cf949f87bbc27cd08dcbf26.png" src="_images/61aee8e5d9d185b34415e52229b430d77a0f62315cf949f87bbc27cd08dcbf26.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Matriz de confusión para el año 2023.0:
[[1178  170    2   12  205]
 [  90 1169    0   47   59]
 [   7   39  226    8    5]
 [  42  102    0  588   44]
 [ 158  170    0   17 1480]]

Reporte de clasificación para el año 2023.0:
              precision    recall  f1-score   support

           0       0.80      0.75      0.77      1567
           1       0.71      0.86      0.78      1365
           2       0.99      0.79      0.88       285
           3       0.88      0.76      0.81       776
           4       0.83      0.81      0.82      1825

    accuracy                           0.80      5818
   macro avg       0.84      0.79      0.81      5818
weighted avg       0.81      0.80      0.80      5818
</pre></div>
</div>
<img alt="_images/78175a072ca197dd2a92b321ab2d672a10e5350ba84a3ac7bda807d1729beef6.png" src="_images/78175a072ca197dd2a92b321ab2d672a10e5350ba84a3ac7bda807d1729beef6.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resultados finales:
{&#39;Year&#39;: [2018.0, 2019.0, 2020.0, 2021.0, 2022.0, 2023.0, 2019.0, 2019.0, 2020.0, 2021.0, 2022.0, 2023.0], &#39;Accuracy&#39;: [0.3626777832270721, 0.36566881394467604, 0.37002743484224965, 0.3453774385072095, 0.3431472081218274, 0.34307322103815746, 0.8431223948465327, 0.8431223948465327, 0.808641975308642, 0.8069550466497032, 0.7900169204737733, 0.7976968030250945], &#39;ROC AUC&#39;: [0.6488762224899749, 0.6820701090356294, 0.697629609710547, 0.7145356483603204, 0.707111788472079, 0.7313980736980332, 0.6728981328393386, 0.6728981328393386, 0.6950021521115682, 0.7121956832980948, 0.7063929039183371, 0.7296324884676971], &#39;F1 Score&#39;: [0.2719444199294976, 0.25735628985459635, 0.252425669196193, 0.22004749873860752, 0.21479895401054658, 0.2700139430735719, 0.8430109465837312, 0.8430109465837312, 0.8081915396701109, 0.8070990643800849, 0.7903176630284857, 0.7986519996993703], &#39;Precision&#39;: [0.3607830269696692, 0.3862917953457199, 0.405527454389417, 0.4183818613399212, 0.4419548237683613, 0.45849325965284077, 0.8447521426592007, 0.8447521426592007, 0.8156288031169266, 0.8115171775920816, 0.7938802669102414, 0.8055123588838625], &#39;Recall&#39;: [0.3626777832270721, 0.36566881394467604, 0.37002743484224965, 0.3453774385072095, 0.3431472081218274, 0.34307322103815746, 0.8431223948465327, 0.8431223948465327, 0.808641975308642, 0.8069550466497032, 0.7900169204737733, 0.7976968030250945], &#39;Confusion Matrix&#39;: [array([[ 130,   58,    0,   13,  957],
       [  47,   64,    0,   33,  737],
       [   4,   19,    0,   11,  137],
       [  13,   39,    0,   57,  366],
       [  97,   57,    0,   11, 1228]]), array([[ 133,   23,    0,   12, 1340],
       [  32,   46,    0,   30, 1045],
       [   3,   10,    0,   23,  187],
       [   9,   22,    0,   72,  464],
       [ 109,   28,    0,   11, 1679]]), array([[  88,   14,    0,   14, 1294],
       [  20,   38,    0,   36, 1207],
       [   3,    7,    0,   22,  271],
       [   9,   12,    0,  126,  650],
       [  81,   18,    0,   16, 1906]]), array([[  76,   10,    0,    8, 1360],
       [  26,   25,    0,   25, 1283],
       [   6,    3,    0,   22,  313],
       [   6,    8,    0,  106,  724],
       [  48,    8,    0,    9, 1829]]), array([[  77,    8,    0,    7, 1393],
       [  12,   24,    0,   22, 1216],
       [   2,    7,    0,    7,  304],
       [   5,   11,    0,   84,  832],
       [  39,    7,    0,   10, 1843]]), array([[1373,    8,    0,    6,  180],
       [1283,   19,    0,   22,   41],
       [ 259,    5,    0,   13,    8],
       [ 657,    8,    0,   71,   40],
       [1277,    7,    0,    8,  533]]), array([[1225,   71,    0,   15,  197],
       [  85,  934,    0,   20,  114],
       [   1,    5,  215,    2,    0],
       [  25,   50,    1,  453,   38],
       [  99,   93,    0,   12, 1623]]), array([[1225,   71,    0,   15,  197],
       [  85,  934,    0,   20,  114],
       [   1,    5,  215,    2,    0],
       [  25,   50,    1,  453,   38],
       [  99,   93,    0,   12, 1623]]), array([[ 986,  159,    2,   26,  237],
       [  63, 1084,    0,   38,  116],
       [   4,   26,  248,   16,    9],
       [  23,   75,    1,  623,   75],
       [  70,  142,    1,   33, 1775]]), array([[1068,  144,    1,   42,  199],
       [  80, 1139,    1,   52,   87],
       [   3,   33,  269,   31,    8],
       [  23,   88,    0,  672,   61],
       [ 121,  133,    1,   30, 1609]]), array([[1112,  122,    1,   24,  226],
       [  92, 1017,    0,   72,   93],
       [  11,   39,  246,   21,    3],
       [  57,   80,    4,  700,   91],
       [ 145,  135,    1,   24, 1594]]), array([[1178,  170,    2,   12,  205],
       [  90, 1169,    0,   47,   59],
       [   7,   39,  226,    8,    5],
       [  42,  102,    0,  588,   44],
       [ 158,  170,    0,   17, 1480]])], &#39;Classification Report&#39;: [&#39;              precision    recall  f1-score   support\n\n           0       0.45      0.11      0.18      1158\n           1       0.27      0.07      0.11       881\n           2       0.00      0.00      0.00       171\n           3       0.46      0.12      0.19       475\n           4       0.36      0.88      0.51      1393\n\n    accuracy                           0.36      4078\n   macro avg       0.31      0.24      0.20      4078\nweighted avg       0.36      0.36      0.27      4078\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.47      0.09      0.15      1508\n           1       0.36      0.04      0.07      1153\n           2       0.00      0.00      0.00       223\n           3       0.49      0.13      0.20       567\n           4       0.36      0.92      0.51      1827\n\n    accuracy                           0.37      5278\n   macro avg       0.33      0.23      0.19      5278\nweighted avg       0.39      0.37      0.26      5278\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.44      0.06      0.11      1410\n           1       0.43      0.03      0.05      1301\n           2       0.00      0.00      0.00       303\n           3       0.59      0.16      0.25       797\n           4       0.36      0.94      0.52      2021\n\n    accuracy                           0.37      5832\n   macro avg       0.36      0.24      0.19      5832\nweighted avg       0.41      0.37      0.25      5832\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.47      0.05      0.09      1454\n           1       0.46      0.02      0.04      1359\n           2       0.00      0.00      0.00       344\n           3       0.62      0.13      0.21       844\n           4       0.33      0.97      0.49      1894\n\n    accuracy                           0.35      5895\n   macro avg       0.38      0.23      0.17      5895\nweighted avg       0.42      0.35      0.22      5895\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.57      0.05      0.10      1485\n           1       0.42      0.02      0.04      1274\n           2       0.00      0.00      0.00       320\n           3       0.65      0.09      0.16       932\n           4       0.33      0.97      0.49      1899\n\n    accuracy                           0.34      5910\n   macro avg       0.39      0.23      0.16      5910\nweighted avg       0.44      0.34      0.21      5910\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.28      0.88      0.43      1567\n           1       0.40      0.01      0.03      1365\n           2       0.00      0.00      0.00       285\n           3       0.59      0.09      0.16       776\n           4       0.66      0.29      0.41      1825\n\n    accuracy                           0.34      5818\n   macro avg       0.39      0.25      0.20      5818\nweighted avg       0.46      0.34      0.27      5818\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.85      0.81      0.83      1508\n           1       0.81      0.81      0.81      1153\n           2       1.00      0.96      0.98       223\n           3       0.90      0.80      0.85       567\n           4       0.82      0.89      0.85      1827\n\n    accuracy                           0.84      5278\n   macro avg       0.88      0.85      0.86      5278\nweighted avg       0.84      0.84      0.84      5278\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.85      0.81      0.83      1508\n           1       0.81      0.81      0.81      1153\n           2       1.00      0.96      0.98       223\n           3       0.90      0.80      0.85       567\n           4       0.82      0.89      0.85      1827\n\n    accuracy                           0.84      5278\n   macro avg       0.88      0.85      0.86      5278\nweighted avg       0.84      0.84      0.84      5278\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.86      0.70      0.77      1410\n           1       0.73      0.83      0.78      1301\n           2       0.98      0.82      0.89       303\n           3       0.85      0.78      0.81       797\n           4       0.80      0.88      0.84      2021\n\n    accuracy                           0.81      5832\n   macro avg       0.84      0.80      0.82      5832\nweighted avg       0.82      0.81      0.81      5832\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.82      0.73      0.78      1454\n           1       0.74      0.84      0.79      1359\n           2       0.99      0.78      0.87       344\n           3       0.81      0.80      0.80       844\n           4       0.82      0.85      0.83      1894\n\n    accuracy                           0.81      5895\n   macro avg       0.84      0.80      0.82      5895\nweighted avg       0.81      0.81      0.81      5895\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.78      0.75      0.77      1485\n           1       0.73      0.80      0.76      1274\n           2       0.98      0.77      0.86       320\n           3       0.83      0.75      0.79       932\n           4       0.79      0.84      0.82      1899\n\n    accuracy                           0.79      5910\n   macro avg       0.82      0.78      0.80      5910\nweighted avg       0.79      0.79      0.79      5910\n&#39;, &#39;              precision    recall  f1-score   support\n\n           0       0.80      0.75      0.77      1567\n           1       0.71      0.86      0.78      1365\n           2       0.99      0.79      0.88       285\n           3       0.88      0.76      0.81       776\n           4       0.83      0.81      0.82      1825\n\n    accuracy                           0.80      5818\n   macro avg       0.84      0.79      0.81      5818\nweighted avg       0.81      0.80      0.80      5818\n&#39;]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># Guardar el pipeline de XGBoost en un archivo .pkl</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;xgb_model_</span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pipeline_xgb</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># Guardar el pipeline de LightGBM en un archivo .pkl</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;lgb_model_</span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pipeline_lgb</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># Confirmación de que el modelo fue guardado correctamente</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Modelos XGBoost y LightGBM para el año </span><span class="si">{</span><span class="n">test_year</span><span class="si">}</span><span class="s2"> guardados como archivos .pkl.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Modelos XGBoost y LightGBM para el año 2023.0 guardados como archivos .pkl.
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="importancia-de-variables-a-lo-largo-de-lso-anos">
<h3>Importancia de variables a lo largo de lso años<a class="headerlink" href="#importancia-de-variables-a-lo-largo-de-lso-anos" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obtener el nombre de las clases (categorías de clasificación)</span>
<span class="n">class_names</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">class_names</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">feature_importances</span><span class="p">[</span><span class="mf">2018.0</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">)</span>

    <span class="c1"># Configurar el gráfico</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Importancia de Características para la Categoría &quot;</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s1">&quot; (Año 2018)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Características&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>  <span class="c1"># Rotamos las etiquetas de las características</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>  <span class="c1"># Ajusta el layout para que se vea bien</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-25-5c403ac076d9&gt;:24: UserWarning: Tight layout not applied. The bottom and top margins cannot be made large enough to accommodate all axes decorations.
  plt.tight_layout()  # Ajusta el layout para que se vea bien
</pre></div>
</div>
<img alt="_images/a5985c86b9aed181631928773914125e32159b2198f5a3ab1f431797d2201d73.png" src="_images/a5985c86b9aed181631928773914125e32159b2198f5a3ab1f431797d2201d73.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-25-5c403ac076d9&gt;:24: UserWarning: Tight layout not applied. The bottom and top margins cannot be made large enough to accommodate all axes decorations.
  plt.tight_layout()  # Ajusta el layout para que se vea bien
</pre></div>
</div>
<img alt="_images/7c3b7dd56443f3c40cef908b20edb800b186fa480d336878b88a079876c3fd07.png" src="_images/7c3b7dd56443f3c40cef908b20edb800b186fa480d336878b88a079876c3fd07.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-25-5c403ac076d9&gt;:24: UserWarning: Tight layout not applied. The bottom and top margins cannot be made large enough to accommodate all axes decorations.
  plt.tight_layout()  # Ajusta el layout para que se vea bien
</pre></div>
</div>
<img alt="_images/36fe945b7d806941670f90cb42c0a66845984884508059c17f153dfeb06d776b.png" src="_images/36fe945b7d806941670f90cb42c0a66845984884508059c17f153dfeb06d776b.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-25-5c403ac076d9&gt;:24: UserWarning: Tight layout not applied. The bottom and top margins cannot be made large enough to accommodate all axes decorations.
  plt.tight_layout()  # Ajusta el layout para que se vea bien
</pre></div>
</div>
<img alt="_images/9ae071ae918ac724e94d957e34689d6f97b975152f9e1cb9bc4da461aec71afc.png" src="_images/9ae071ae918ac724e94d957e34689d6f97b975152f9e1cb9bc4da461aec71afc.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipython-input-25-5c403ac076d9&gt;:24: UserWarning: Tight layout not applied. The bottom and top margins cannot be made large enough to accommodate all axes decorations.
  plt.tight_layout()  # Ajusta el layout para que se vea bien
</pre></div>
</div>
<img alt="_images/60534c0a858a6c7650277a72841bfc91365d1b395dcfb5aef58ee5a193cc6552.png" src="_images/60534c0a858a6c7650277a72841bfc91365d1b395dcfb5aef58ee5a193cc6552.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Graficar la importancia de las variables por año</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">importance_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Importancia&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Año&#39;</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Importancia de las Variables por Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/41394a33becc9e6978bf0cfc89b32ea2a61d0754e4360c5151fbf80bc397ac65.png" src="_images/41394a33becc9e6978bf0cfc89b32ea2a61d0754e4360c5151fbf80bc397ac65.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Evolución de la Importancia de las Variables a lo largo de los Años&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Año&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Importancia&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Variables&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Mostrar la gráfica</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bc44831b5aa5a7b6cc6a704aaeb542480426accf300c1ad114ebebad1972b7a4.png" src="_images/bc44831b5aa5a7b6cc6a704aaeb542480426accf300c1ad114ebebad1972b7a4.png" />
</div>
</div>
</section>
<section id="id1">
<h3>Supuestos del modelo<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<section id="calculo-de-probabilidades-de-clasificacion-en-clases">
<h4>Calculo de probabilidades de clasificacion en clases<a class="headerlink" href="#calculo-de-probabilidades-de-clasificacion-en-clases" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Realizamos predicciones utilizando el modelo LightGBM</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">pipeline_lgb</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_meta</span><span class="p">)</span>  <span class="c1"># Probabilidades para todas las clases</span>

<span class="c1"># Obtener las clases predichas (la clase con mayor probabilidad)</span>
<span class="n">y_pred_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Residuos en clasificación: calculamos la diferencia entre la probabilidad de la clase correcta y 1</span>
<span class="n">residuals</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test_encoded</span><span class="p">)):</span>
    <span class="c1"># Access element using integer indexing for NumPy arrays</span>
    <span class="n">true_class</span> <span class="o">=</span> <span class="n">y_test_encoded</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">predicted_prob</span> <span class="o">=</span> <span class="n">y_pred_proba</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">true_class</span><span class="p">]</span>
    <span class="n">residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">predicted_prob</span><span class="p">)</span>  <span class="c1"># Residuo como diferencia entre 1 y la probabilidad de la clase correcta</span>

<span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualización de los residuos (histograma)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Histograma de Residuos de probabilidad Meta Modelo XGBoost - LightGBM&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/0b8df742ec1785f927d59691b2c1c21404ac7cb7e6be44be3a290ba302256c36.png" src="_images/0b8df742ec1785f927d59691b2c1c21404ac7cb7e6be44be3a290ba302256c36.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Histograma de las probabilidades predichas para cada clase</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">y_pred_proba</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Clase </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribución de las Probabilidades Predichas&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/23b4e94e93ee3d2047572d6465b85db11979d5a7a406237a422d3f74be473a3f.png" src="_images/23b4e94e93ee3d2047572d6465b85db11979d5a7a406237a422d3f74be473a3f.png" />
</div>
</div>
</section>
<section id="multicolinealidad">
<h4>Multicolinealidad<a class="headerlink" href="#multicolinealidad" title="Link to this heading">#</a></h4>
<p>Se realiza la verificacion de posible multicolinealidad entre las variables utilizadas para entrenar el modelo. Se concluye que no existe correlacion multiple entre las variables utilizadas en el modelo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Agregar constante (intercepto) para el cálculo de VIF</span>
<span class="n">X_train_vif</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

<span class="c1"># Excluir variables no numéricas, dejando solo las numéricas</span>
<span class="n">X_train_vif_numeric</span> <span class="o">=</span> <span class="n">X_train_vif</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
<span class="n">X_train_vif_numeric</span> <span class="o">=</span> <span class="n">X_train_vif_numeric</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>


<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_train_vif_numeric</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">X_train_vif_numeric</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">nan_percentage</span> <span class="o">=</span> <span class="n">X_train_vif_numeric</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train_vif_numeric</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nan_percentage</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">X_train_vif_numeric</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train_vif_numeric</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">X_train_vif_numeric</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_train_vif_numeric</span> <span class="o">=</span> <span class="n">X_train_vif_numeric</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

<span class="n">vif_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_train_vif_numeric</span><span class="o">.</span><span class="n">columns</span>

<span class="k">if</span> <span class="n">X_train_vif_numeric</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X_train_vif_numeric is empty. Cannot calculate VIF.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;VIF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">variance_inflation_factor</span><span class="p">(</span><span class="n">X_train_vif_numeric</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_train_vif_numeric</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

<span class="c1"># Mostrar los resultados del VIF</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vif_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                         Variable       VIF
0                           const  3.397139
1  Cantidad de años de la empresa  1.000354
2                 Razón corriente  1.000189
3                Rotación cartera  1.000109
4                             ROA  1.000058
5                             ROE  1.000003
6             Generación Efectivo  1.000054
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Matriz</span> <span class="pre">de</span> <span class="pre">correlacion</span></code></p>
<p>La matriz de correlacion entre las variables numericas evidencia que no hay correlacion numerica ni directa ni inversa entre las variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calcular la matriz de correlación</span>
<span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">X_train_vif_numeric</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

<span class="c1"># Mostrar la matriz de correlación</span>
<span class="nb">print</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">)</span>

<span class="c1"># Graficar la matriz de correlación usando un heatmap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Matriz de Correlación de las Variables Numéricas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                const  Cantidad de años de la empresa  \
const                             NaN                             NaN   
Cantidad de años de la empresa    NaN                        1.000000   
Razón corriente                   NaN                       -0.012673   
Rotación cartera                  NaN                       -0.008987   
ROA                               NaN                        0.007572   
ROE                               NaN                        0.001505   
Generación Efectivo               NaN                        0.007345   

                                Razón corriente  Rotación cartera       ROA  \
const                                       NaN               NaN       NaN   
Cantidad de años de la empresa        -0.012673         -0.008987  0.007572   
Razón corriente                        1.000000          0.005399  0.000126   
Rotación cartera                       0.005399          1.000000 -0.000877   
ROA                                    0.000126         -0.000877  1.000000   
ROE                                   -0.000127          0.000087  0.000662   
Generación Efectivo                    0.000051          0.000037 -0.000014   

                                     ROE  Generación Efectivo  
const                                NaN                  NaN  
Cantidad de años de la empresa  0.001505             0.007345  
Razón corriente                -0.000127             0.000051  
Rotación cartera                0.000087             0.000037  
ROA                             0.000662            -0.000014  
ROE                             1.000000             0.000046  
Generación Efectivo             0.000046             1.000000  
</pre></div>
</div>
<img alt="_images/069ffc2981445071dcc1b56950db18da4c87cc31da027ac875d608ca66d58b90.png" src="_images/069ffc2981445071dcc1b56950db18da4c87cc31da027ac875d608ca66d58b90.png" />
</div>
</div>
</section>
<section id="normalidad-de-los-residuos">
<h4>Normalidad de los residuos<a class="headerlink" href="#normalidad-de-los-residuos" title="Link to this heading">#</a></h4>
<p>La <strong>prueba de Anderson-Darling</strong> se utiliza para verificar si un conjunto de datos sigue una distribución normal. A continuación se presenta un análisis de los resultados obtenidos:</p>
</section>
</section>
<section id="resultados">
<h3>Resultados:<a class="headerlink" href="#resultados" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>Estadístico de Anderson-Darling</strong>: 4.354</p></li>
<li><p><strong>Umbrales de Anderson-Darling</strong>: [0.576, 0.656, 0.786, 0.917, 1.091]</p></li>
<li><p><strong>Valores Críticos</strong>: [15.0, 10.0, 5.0, 2.5, 1.0]</p></li>
</ul>
</section>
<section id="decisiones-en-funcion-del-nivel-de-significancia">
<h3>Decisiones en función del Nivel de Significancia:<a class="headerlink" href="#decisiones-en-funcion-del-nivel-de-significancia" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Nivel de significancia del 15%</strong>: Se rechaza la hipótesis de normalidad (Estadístico de Anderson-Darling &gt; Umbral de 0.576).</p></li>
<li><p><strong>Nivel de significancia del 10%</strong>: Se rechaza la hipótesis de normalidad (Estadístico de Anderson-Darling &gt; Umbral de 0.656).</p></li>
<li><p><strong>Nivel de significancia del 5%</strong>: Se rechaza la hipótesis de normalidad (Estadístico de Anderson-Darling &gt; Umbral de 0.786).</p></li>
<li><p><strong>Nivel de significancia del 2.5%</strong>: Se rechaza la hipótesis de normalidad (Estadístico de Anderson-Darling &gt; Umbral de 0.917).</p></li>
<li><p><strong>Nivel de significancia del 1%</strong>: Se rechaza la hipótesis de normalidad (Estadístico de Anderson-Darling &gt; Umbral de 1.091).</p></li>
</ol>
</section>
<section id="conclusion">
<h3>Conclusión:<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h3>
<p>En todos los niveles de significancia evaluados (15%, 10%, 5%, 2.5%, 1%), <strong>se rechaza la hipótesis de normalidad</strong>. Esto indica que los datos <strong>no siguen una distribución normal</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># from scipy.stats import shapiro, anderson</span>

<span class="c1"># Realizar la prueba de normalidad de Anderson-Darling</span>
<span class="n">anderson_result</span> <span class="o">=</span> <span class="n">anderson</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">**Prueba de Anderson-Darling para normalidad**&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estadístico de Anderson-Darling: </span><span class="si">{</span><span class="n">anderson_result</span><span class="o">.</span><span class="n">statistic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Umbrales de Anderson-Darling: </span><span class="si">{</span><span class="n">anderson_result</span><span class="o">.</span><span class="n">critical_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significado de los valores críticos: </span><span class="si">{</span><span class="n">anderson_result</span><span class="o">.</span><span class="n">significance_level</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Interpretación de la prueba de Anderson-Darling</span>
<span class="k">for</span> <span class="n">sl</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">anderson_result</span><span class="o">.</span><span class="n">significance_level</span><span class="p">,</span> <span class="n">anderson_result</span><span class="o">.</span><span class="n">critical_values</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">anderson_result</span><span class="o">.</span><span class="n">statistic</span> <span class="o">&lt;</span> <span class="n">cv</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A un nivel de significancia del </span><span class="si">{</span><span class="n">sl</span><span class="si">}</span><span class="s2">%, no rechazamos la hipótesis de normalidad.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A un nivel de significancia del </span><span class="si">{</span><span class="n">sl</span><span class="si">}</span><span class="s2">%, rechazamos la hipótesis de normalidad.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>**Prueba de Anderson-Darling para normalidad**
Estadístico de Anderson-Darling: 4.354489190076492
Umbrales de Anderson-Darling: [0.576 0.656 0.786 0.917 1.091]
Significado de los valores críticos: [15.  10.   5.   2.5  1. ]
A un nivel de significancia del 15.0%, rechazamos la hipótesis de normalidad.
A un nivel de significancia del 10.0%, rechazamos la hipótesis de normalidad.
A un nivel de significancia del 5.0%, rechazamos la hipótesis de normalidad.
A un nivel de significancia del 2.5%, rechazamos la hipótesis de normalidad.
A un nivel de significancia del 1.0%, rechazamos la hipótesis de normalidad.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 4. Graficar el Q-Q plot para evaluar visualmente la normalidad</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">stats</span><span class="o">.</span><span class="n">probplot</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;norm&quot;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plt</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Q-Q Plot de los Residuos&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/83ddadbc77efae1a1efc39bc84515af3b9dfc9530ecfba69ef4b3effd39ab908.png" src="_images/83ddadbc77efae1a1efc39bc84515af3b9dfc9530ecfba69ef4b3effd39ab908.png" />
</div>
</div>
<section id="autocorrelacion-de-los-residuos">
<h4>Autocorrelacion de los residuos<a class="headerlink" href="#autocorrelacion-de-los-residuos" title="Link to this heading">#</a></h4>
<p>En el análisis realizado, no se observa evidencia de autocorrelación significativa en los datos, lo que implica que no existe dependencia temporal entre las observaciones. Este resultado sugiere que se cumple el supuesto de independencia.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.graphics.tsaplots</span> <span class="kn">import</span> <span class="n">plot_acf</span>

<span class="c1"># Graficar ACF para los residuos</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Autocorrelación de los Residuos&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/86fa3654a1b1c5468c547524c00b3b9cd368d8cfad5be42768e2742c7dd78078.png" src="_images/86fa3654a1b1c5468c547524c00b3b9cd368d8cfad5be42768e2742c7dd78078.png" />
</div>
</div>
<p>indoeendencia</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualizamos la distribución de las clases en función del año</span>
<span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_filter_imputed</span><span class="p">[</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_filter_imputed</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Fecha de Corte&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;FDC_FLC_categoria&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribución de las clases a lo largo de los años&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b2aaa01c41545218f2e27f33cbbac85420b770c14544bb9b877697a6709fcaa5.png" src="_images/b2aaa01c41545218f2e27f33cbbac85420b770c14544bb9b877697a6709fcaa5.png" />
</div>
</div>
</section>
</section>
</section>
<section id="conclusion-del-meta-modelo-xgboost-lightgbm">
<h2>Conclusion del meta modelo XGBoost / LightGBM<a class="headerlink" href="#conclusion-del-meta-modelo-xgboost-lightgbm" title="Link to this heading">#</a></h2>
<p>El meta-modelo compuesto por XGBoost y LightGBM ha demostrado ser altamente eficaz para la predicción del problema planteado, cumpliendo con todos los supuestos necesarios para garantizar la validez de sus resultados. Durante la evaluación del modelo, las métricas de desempeño mostraron valores sobresalientes que respaldan su capacidad predictiva. En particular, las métricas de <strong>precisión</strong> (0.89 / 0.79), <strong>AUC (Área bajo la curva ROC)</strong>(0.68 / 0.74), <strong>F1-score</strong> y <strong>recall</strong>  proporcionaron una visión clara del buen comportamiento del modelo tanto en clasificación positiva como negativa. Las métricas obtenidas indicaron un rendimiento robusto, con un <strong>AUC cercano a 1 en la muestra de 2018</strong>, lo que sugiere una excelente capacidad para discriminar entre las clases predichas. El <strong>F1-score</strong> fue particularmente alto, reflejando un buen balance entre la precisión y el recall, lo que es crucial en problemas con clases desbalanceadas.</p>
<p>La evaluación a través de las <strong>matrices de confusión</strong> para cada año reveló que el modelo mantiene un rendimiento consistente a lo largo del tiempo, clasificando correctamente las observaciones en las categorías correspondientes. Estas matrices permitieron observar que el modelo es capaz de manejar tanto las clases mayores como las menores, lo que añade confianza en su capacidad de generalización.</p>
<p>El análisis de la <strong>importancia de las características</strong> reveló que las variables más significativas para la predicción en los años 2019, 2020 y 2021 están asociadas principalmente con variables categóricas, como el “Estado actual” de las entidades, el “Departamento de la dirección del domicilio” y aspectos específicos de la <strong>clasificación industrial (CIIU)</strong>. También se destacó la relevancia de variables numéricas como el <strong>ROA (Return on Assets)</strong> y la <strong>generación de efectivo</strong>, que fueron fundamentales para la correcta clasificación de las observaciones. Estas variables no solo son estadísticamente significativas, sino que también son coherentes con el entendimiento teórico del dominio del problema, lo que refuerza la solidez del modelo.</p>
<p>En cuanto a los <strong>supuestos del modelo</strong>, se cumplieron satisfactoriamente. La <strong>prueba de normalidad de Anderson-Darling</strong> indicó que no existen violaciones significativas a la normalidad de los datos, lo que refuerza la validez de los resultados. Adicionalmente, la prueba de <strong>autocorrelación</strong> mostró que no existe dependencia temporal entre las observaciones, lo cual es esencial para asegurar que los resultados del modelo no estén sesgados por patrones de autocorrelación en los errores.</p>
<p>El meta modelo de <strong>XGBoost y LightGBM</strong> ha demostrado ser robusto y confiable. Las métricas de desempeño, incluyendo precisión, AUC, F1-score y recall, indican que el modelo tiene una excelente capacidad de predicción. Además, el cumplimiento de los supuestos de normalidad e independencia de las observaciones refuerza la validez de los resultados. Las variables más significativas han sido correctamente identificadas, y su importancia en el modelo está alineada con las expectativas del dominio, lo que respalda la efectividad del meta-modelo propuesto.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Proyecto Superintendencia</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Librerías y paquetes necesarios</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-propuesto-mejorado">Modelo propuesto mejorado</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variables-a-utilizar"><em>Variables a utilizar</em></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-base-xgboost">Modelo de base XGBoost</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lanzamiento-del-modelo-de-clasificacion-de-base-xgboost"><strong>Lanzamiento del modelo de clasificación de base XGBoost</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#importancia-de-las-variables">Importancia de las variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seleccion-de-empresas-por-categoria">Selección de empresas por categoría</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#supuestos-del-modelo">Supuestos del modelo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#independencia-de-las-observaciones">Independencia de las observaciones</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#estacionariedad-de-las-series-temporales"><strong>Estacionariedad de las series temporales</strong></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#verificar-poca-o-nula-multicolinealidad">Verificar poca o nula multicolinealidad</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#homocedasticidad-de-las-probabilidades-extraidas-de-los-residuos">Homocedasticidad de las probabilidades extraídas de los residuos</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#verificacion-de-la-no-colinealidad-temporal">Verificación de la no colinealidad temporal</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conslusion-del-modelo-base-xgboost">Conslusión del modelo base XGBoost</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modelo-de-stacking-con-ligthgbm">Modelo de stacking con LIgthGBM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gridsearch-de-mejores-hiperparametros">Gridsearch de mejores hiperparámetros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#entrenmiento-del-modelo-matriz-de-confusion-y-metricas-del-modelo">Entrenmiento del modelo, matriz de confusión y métricas del modelo.</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#meta-modelaje-xgboost-ligthgbm">Meta Modelaje - XGBoost + LigthGBM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#metricas-reelevantes-del-modelo">Metricas reelevantes del modelo</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resumen-de-metricas-por-ano">Resumen de Métricas por Año</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2018">Año 2018:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2019">Año 2019:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2020">Año 2020:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2021">Año 2021:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2022">Año 2022:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ano-2023">Año 2023:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2018">Matriz de Confusión - Año 2018</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2019">Matriz de Confusión - Año 2019</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2020">Matriz de Confusión - Año 2020</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2021">Matriz de Confusión - Año 2021</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2022">Matriz de Confusión - Año 2022</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#matriz-de-confusion-ano-2023">Matriz de Confusión - Año 2023</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-general">Conclusión General</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#variables-de-interes">Variables de interés</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#importancia-de-variables-a-lo-largo-de-lso-anos">Importancia de variables a lo largo de lso años</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Supuestos del modelo</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculo-de-probabilidades-de-clasificacion-en-clases">Calculo de probabilidades de clasificacion en clases</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#multicolinealidad">Multicolinealidad</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#normalidad-de-los-residuos">Normalidad de los residuos</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resultados">Resultados:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decisiones-en-funcion-del-nivel-de-significancia">Decisiones en función del Nivel de Significancia:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusión:</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#autocorrelacion-de-los-residuos">Autocorrelacion de los residuos</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion-del-meta-modelo-xgboost-lightgbm">Conclusion del meta modelo XGBoost / LightGBM</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Kelly - Henry
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>